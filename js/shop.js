let Products = [
  {
    nameSP: "LEVENTS® | DORAEMON FAMOUS CAT TEE",
    img: "./img/products/p1-1.png",
    price: 370000,
    nametag: "aothun#",
    idproduct: "abc",
    colorr1: "gray",
    colorr2: "red",
    colorr3: "unset",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    img1: "./img/products/p1-1.png",
    img2: "./img/products/p1-2.jpg",
    img3: "./img/products/p1-2.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON COLLAB TEE",
    img: "./img/products/p2-1.png",
    price: 450000,
    nametag: "aothun#",
    idproduct: "",
    colorr1: "brown",
    colorr2: "black",
    colorr3: "unset",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    img1: "./img/products/p2-1.png",
    img2: "./img/products/p2-2.png",
    img3: "./img/products/p2-2.png",
  },
  {
    nameSP: "LEVENTS® DINOSAUR TEE",
    img: "./img/products/p3-1.jpg",
    price: 420000,
    nametag: "aothun#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "blue",
    img1: "./img/products/p3-1.jpg",
    img2: "./img/products/p3-2.jpg",
    img3: "./img/products/p3-3.jpg",
  },
  {
    nameSP: "LEVENTS® INSIDE OUT TEE",
    img: "./img/products/p4-1.jpg",
    price: 390000,
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    nametag: "aothun#",
    idproduct: "",
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p4-1.jpg",
    img2: "./img/products/p4-2.jpg",
    img3: "./img/products/p4-2.jpg",
  },
  {
    nameSP: "LEVENTS® LOVEYOU300K SPECIAL TEE",
    img: "./img/products/p5-1.jpg",
    price: 300000,
    nametag: "aothun#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " rgb(235, 232, 226)",
    colorr2: "unset",
    idproduct: "",
    colorr3: "unset",
    img1: "./img/products/p5-1.jpg",
    img2: "./img/products/p5-1.jpg",
    img3: "./img/products/p5-1.jpg",
  },
  {
    nameSP: "LEVENTS® FUNNY CROCODILE TEE",
    img: "./img/products/p6-1.jpg",
    price: 390000,
    nametag: "aothun#",
    colorr1: "blue",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p6-1.jpg",
    img2: "./img/products/p6.jpg",
    img3: "./img/products/p6-2.jpg",
  },
  {
    nameSP: "LEVENTS® PUNCH VARSITY",
    img: "./img/products/p7-1.jpg",
    price: 890000,
    nametag: "aokhoac#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: "brown",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p7-1.jpg",
    img2: "./img/products/p7-2.jpg",
    img3: "./img/products/p7-2.jpg",
  },
  {
    nameSP: "LEVENTS® SELFLOVE BOXY TEE",
    img: "./img/products/p8-1.jpg",
    price: 380000,
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    nametag: "aothun#",
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p8-1.jpg",
    img2: "./img/products/p8-2.jpg",
    img3: "./img/products/p8-1.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON MINI CAT Polo",
    img: "./img/products/p9-1.jpg",
    price: 405000,
    nametag: "polo#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p9-1.jpg",
    img2: "./img/products/p9-2.jpg",
    img3: "./img/products/p9-2.jpg",
  },
  {
    nameSP: "LEVENTS® MINI POPULAR Polo",
    img: "./img/products/p10-1.jpg",
    price: 370000,
    nametag: "polo#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p10-1.jpg",
    img2: "./img/products/p10-2.jpg",
    img3: "./img/products/p10-2.jpg",
  },
  {
    nameSP: "LEVENTS® STRIPE Polo",
    img: "./img/products/p11-1.jpg",
    price: 420000,
    idproduct: "",
    nametag: "polo#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p11-1.jpg",
    img2: "./img/products/p11-2.jpg",
    img3: "./img/products/p11-2.jpg",
  },
  {
    nameSP: "LEVENTS® CINEMA SHIRT",
    img: "./img/products/p12-1.jpg",
    price: 420000,
    nametag: "somi#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr1: "brown",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p12-1.jpg",
    img2: "./img/products/p12-2.jpg",
    img3: "./img/products/p12-2.jpg",
  },
  {
    nameSP: "LEVENTS® CITIES SHIRT",
    img: "./img/products/p13-1.jpg",
    price: 420000,
    nametag: "somi#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p13-1.jpg",
    img2: "./img/products/p13-2.jpg",
    img3: "./img/products/p13-2.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON COLLAB ZIPPER Hoodie",
    img: "./img/products/p14-1.jpg",
    price: 645000,
    nametag: "hoodie#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " rgb(235, 232, 226)",
    colorr2: "gray",
    colorr3: "unset",
    img1: "./img/products/p14-1.jpg",
    img2: "./img/products/p14-2.jpg",
    img3: "./img/products/p14-2.jpg",
  },
  {
    nameSP: "LEVENTS® POPULAR LOGO 2.0 Hoodie",
    img: "./img/products/p15-1.jpg",
    price: 590000,
    nametag: "hoodie#",
    colorr1: "yellow",
    colorr2: "gray",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr3: "black",
    img1: "./img/products/p15-1.jpg",
    img2: "./img/products/p15-2.jpg",
    img3: "./img/products/p15-3.jpg",
  },
  {
    nameSP: "LEVENTS® MINI LOGO ZIPPER Hoodie",
    img: "./img/products/p16-1.jpg",
    price: 620000,
    nametag: "hoodie#",
    colorr1: " rgb(235, 232, 226)",
    colorr2: "gray",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr3: "unset",
    idproduct: "",
    img1: "./img/products/p16-1.jpg",
    img2: "./img/products/p16-2.jpg",
    img3: "./img/products/p16-2.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON COLLAB Hoodie",
    img: "./img/products/p17-1.jpg",
    price: 620000,
    nametag: "hoodie#",
    colorr1: " rgb(235, 232, 226)",
    colorr2: "black",
    colorr3: "unset",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    img1: "./img/products/p17-1.jpg",
    img2: "./img/products/p17-2.jpg",
    img3: "./img/products/p17-2.jpg",
  },
  {
    nameSP: "LEVENTS® BASIC Sweater",
    img: "./img/products/p18-1.jpg",
    price: 490000,
    nametag: "sweater#",
    idproduct: "",
    colorr1: "gray",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr2: "red",
    colorr3: "unset",
    img1: "./img/products/p18-1.jpg",
    img2: "./img/products/p18-2.jpg",
    img3: "./img/products/p18-2.jpg",
  },
  {
    nameSP: "LEVENTS® FUNNY CROCODILE Sweater",
    img: "./img/products/p19-1.jpg",
    price: 490000,
    nametag: "sweater#",
    colorr1: "brown",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p19-1.jpg",
    img2: "./img/products/p19-2.jpg",
    img3: "./img/products/p19-2.jpg",
  },
];

for (let i = 0; i < Products.length; i++) {
  Products[i].idproduct = Products[i].nametag + i;
}
if (JSON.parse(localStorage.getItem("arrayproducts")) == null) {
  localStorage.setItem("arrayproducts", JSON.stringify(Products));
}
function timkiemtheoID(ID) {
  for (let i = 0; i < Products.length; i++) {
    if (Products[i].idproduct == ID) {
      return Products[i];
    }
  }
  return null;
}

let ProductArrBoth = JSON.parse(localStorage.getItem("arrayproducts"));
let typeproducts = [
  { typeid: "aothun#", typename: "Áo thun" },
  { typeid: "polo#", typename: "Polo" },
  { typeid: "somi#", typename: "Sơ mi" },
  { typeid: "hoodie#", typename: "Hoodie" },
  { typeid: "sweater#", typename: "Sweater" },
  { typeid: "aokhoac#", typename: "Áo khoác" },
];
//Hàm tạo id SP

function makeFilter() {
  let s = `<div class="control">
            <div class="title">
              <h4>Bộ lọc</h4>
              <h3 id="totalResult"></h3>
            </div>
            <div class="ee"><h4>Thuộc</h4></div>`;
  for (let i = 0; i < typeproducts.length; i++) {
    s += `<div class="type">
              <input type="radio" id="${
                typeproducts[i].typeid
              }" onchange="hienSPTheoFilter(this);" class="radio-btn" name="filter-radio" value="${
      i + 1
    }" /><span>${typeproducts[i].typename}</span>
            </div>`;
  }
  s += `<div class="optionFilter">
              <h5>KHOẢNG GIÁ</h5>
            </div>
            <div class="filterPrice">
              <input type="text" id="nodePrice_1" autocomplete="off"/>
              <span style="margin: 5px">-</span>
              <input type="text" id="nodePrice_2" autocomplete="off"/>
            </div>
            <div class="loc"><a href="#" class="cc">Lọc</a></div>
          </div>`;
  document.querySelector(".left").innerHTML = s;
  const radio_btn = document.querySelectorAll(".radio-btn");
  let radiochecked = "";
  radio_btn.forEach((item, i) => {
    item.addEventListener("click", (e) => {
      if (item.checked && radiochecked !== i) {
        radiochecked = i;
        let span = item.nextElementSibling.textContent.trim(); // Lấy giá trị span
        filteredProducts = mangproduct_radio(span, ProductArrBoth);
      } else if (radiochecked >= 0 && i === radiochecked) {
        item.checked = false;
        radiochecked = -1;
        filteredProducts = ProductArrBoth;
      }
      makeSP(1, sosptrongtrang, filteredProducts); // Hiển thị sản phẩm
      makeselectpage(1, filteredProducts); //Tạo phân trang
    });
  });
}

const sale = 0.5;
const sosptrongtrang = 12;
let sp = "";
let max_page = 0;

// Hàm tạo sản phẩm trên trang
function makeSP(trang, sosptrongtrang) {
  let arr = JSON.parse(localStorage.getItem("arrayproducts")) || [];
  let sp = "";
  for (let i = (trang - 1) * sosptrongtrang; i < trang * sosptrongtrang; i++) {
    if (i >= arr.length) break;
    const originalPrice = (arr[i].price + arr[i].price * sale).toLocaleString(
      "vi-VN",
      { style: "currency", currency: "VND" }
    );
    const salePrice = arr[i].price.toLocaleString("vi-VN", {
      style: "currency",
      currency: "VND",
    });
    sp += `
      <div class="item_1" onclick='loadSingleProduct(${JSON.stringify(
        arr[i]
      )})'>
        <div class="img-item"><img class="srcimg" src="${
          arr[i].img
        }" alt=""></div>
        <div class="listColor" id="listColor_item1">
          <div onclick="clickC1(this)" class="itemColor1" data-src="${
            arr[i].img1
          }" style="background-color: ${arr[i].colorr1};"></div>
          <div onclick="clickC1(this)" class="itemColor2" data-src="${
            arr[i].img2
          }" style="background-color: ${arr[i].colorr2};"></div>
          <div onclick="clickC1(this)" class="itemColor3" data-src="${
            arr[i].img3
          }" style="background-color: ${arr[i].colorr3};"></div>
        </div>
        <div class="inf-item">
          <h4>${arr[i].nameSP}</h4>
          <p style="font-style: italic;">Giá gốc: <span style="text-decoration: line-through; font-style: italic;">${originalPrice}</span></p>
          <p style="font-style: italic;">Giá khuyến mãi: <span style="font-size: larger; font-style: italic;">${salePrice}</span></p>
        </div>
      </div>
    `;
  }
  document.getElementById("all-item").innerHTML = sp;
}

// Hàm phân trang
function makeselectpage(index, arr) {
  const max_length_arrayproduct = arr.length;
  max_page = Math.ceil(max_length_arrayproduct / sosptrongtrang);

  let s = `<a href="#" class="pagination_item" id="before"><span><i class='bx bx-left-arrow-alt'></i></span></a>`;

  if (index > 1) {
    s += `<a href="#" class="pagination_item" id="span1"><span>${
      index - 1
    }</span></a>`;
  }

  s += `<a href="#" class="pagination_item act" id="span2"><span>${index}</span></a>`;

  if (index < max_page) {
    s += `<a href="#" class="pagination_item" id="span3"><span>${
      index + 1
    }</span></a>`;
  }

  s += `<a href="#" class="pagination_item" id="next"><span><i class='bx bx-right-arrow-alt'></i></span></a>`;

  document.querySelector("#body-widePagination").innerHTML = s;

  const page1 = document.getElementById("span1");
  const page2 = document.getElementById("span2");
  const page3 = document.getElementById("span3");
  const next = document.getElementById("next");
  const before = document.getElementById("before");

  if (index > 1) {
    before.style.visibility = "visible";
  } else {
    before.style.visibility = "hidden";
  }

  if (index >= max_page) {
    next.style.visibility = "hidden";
  } else {
    next.style.visibility = "visiable";
  }

  if (page1) {
    page1.addEventListener("click", () => {
      const page1content = parseInt(page1.textContent);
      saveCurrentPage(page1content);
      makeSP(page1content, sosptrongtrang, arr);
      makeselectpage(page1content, arr);
    });
  }

  if (page2) {
    page2.addEventListener("click", () => {
      const page2content = parseInt(page2.textContent);
      saveCurrentPage(page2content);
      makeSP(page2content, sosptrongtrang, arr);
      makeselectpage(page2content, arr);
    });
  }

  if (page3) {
    page3.addEventListener("click", () => {
      const page3content = parseInt(page3.textContent);
      saveCurrentPage(page3content);
      makeSP(page3content, sosptrongtrang, arr);
      makeselectpage(page3content, arr);
    });
  }

  if (next) {
    next.addEventListener("click", () => {
      const nextPage = index + 1;
      if (nextPage <= max_page) {
        makeSP(nextPage, sosptrongtrang, arr);
        makeselectpage(nextPage, arr);
      }
    });
  }

  if (before) {
    before.addEventListener("click", () => {
      const previousPage = index - 1;
      if (previousPage > 0) {
        makeSP(previousPage, sosptrongtrang, arr);
        makeselectpage(previousPage, arr);
      }
    });
  }
}

// Hàm để lưu số trang hiện tại vào localStorage
function saveCurrentPage(page) {
  localStorage.setItem("currentPage", page);
}
// Hàm để lấy số trang hiện tại từ localStorage
function getCurrentPage() {
  return parseInt(localStorage.getItem("currentPage")) || 1; // Mặc định là trang 1 nếu không có giá trị
}

// Hàm chạy khi trang tải

// sort
function sapxeptang(arr) {
  for (let i = 0; i < arr.length - 1; i++) {
    for (let j = i + 1; j < arr.length; j++) {
      if (parseInt(arr[i].price) > parseInt(arr[j].price)) {
        let tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
      }
    }
  }
}
function sapxepgiam(arr) {
  for (let i = 0; i < arr.length - 1; i++) {
    for (let j = i + 1; j < arr.length; j++) {
      if (parseInt(arr[i].price) < parseInt(arr[j].price)) {
        let tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
      }
    }
  }
}

//radio-search
function mangproduct_radio(radio, arr) {
  let mang = [];
  for (let i = 0; i < arr.length; i++) {
    // Kiểm tra nếu nametag của đối tượng trong mảng trùng với radio đã chọn
    let s = arr[i].nametag;
    // console.log(s);
    if (s == radio) {
      mang.push(arr[i]);
    }
  }
  return mang;
}
let filteredProducts = ProductArrBoth; // Khởi tạo mảng ban đầu
function hienSPTheoFilter(item) {
  // x = item.id;
  filteredProducts = mangproduct_radio(item.id, ProductArrBoth);
  makeSP(1, sosptrongtrang, filteredProducts);
}
// console.log(x);
// let indexcheck = document.getElementById(x);
// // console.log(indexcheck);
// // if (indexcheck != null) {
// //   indexcheck.addEventListener("click", () => {
// //     // indexcheck.checked = false;
// //     console.log("a");
// //   });
// // }

function Sort(item) {
  let choice = parseInt(item.value);

  // Sử dụng bản sao của mảng gốc để khôi phục khi cần
  let filteredProducts_copy = JSON.parse(JSON.stringify(filteredProducts));
  console.log(filteredProducts);
  switch (choice) {
    case 1:
      sapxeptang(filteredProducts_copy);
      break;
    case 2:
      sapxepgiam(filteredProducts_copy);
      break;
    case 3:
      filteredProducts_copy = filteredProducts;
      break;
  }
  // Hiển thị mảng sau khi sắp xếp hoặc khôi phục
  makeSP(1, sosptrongtrang, filteredProducts_copy);
  makeselectpage(1, filteredProducts_copy);
}

//doi mau sac quan ao
function clickC1(e) {
  const newSrc = e.getAttribute("data-src"); //data-src chứa URL của hình ảnh tương ứng với màu đó.
  const imgElement = e.closest(".item_1").querySelector(".srcimg"); // tìm phần tử cha gần nhất có lớp item_1 ếp tục tìm phần tử ảnh bên trong phần tử cha item_1
  imgElement.setAttribute("src", newSrc);
}
let statusproductcurrent = [
  { statusID: "1", statuscontent: "Chờ xác nhận" },
  { statusID: "2", statuscontent: "Đang gói hàng" },
  { statusID: "3", statuscontent: "Vận chuyển" },
  { statusID: "4", statuscontent: "Hoàn thành" },
];
console.log("abc");
let objcolorcurrent = {
  obj: "",
  color: "",
  img: "",
  soluong: "",
  size: "",
  status: "1",
};
//chi tiet sp
function loadSingleProduct(e) {
  objcolorcurrent.obj = e;
  objcolorcurrent.color = e.colorr1;
  objcolorcurrent.img = e.img1;

  const originalPrice = (e.price + e.price * sale).toLocaleString("vi-VN", {
    style: "currency",
    currency: "VND",
  });
  const salePrice = e.price.toLocaleString("vi-VN", {
    style: "currency",
    currency: "VND",
  });

  const s = `<div class="both_">
               <div class="left_">
                    <div class="img_" id="imgMain">
                        <img class="srcimg" src="${e.img}" alt="">
                    </div>
               </div>
                <div class="right_">
                    <div class="content_">
                        <h2 id="name">${e.nameSP}</h2>
                        <div class="groupPrice">
                            <h3>GIÁ GỐC : <span style="text-decoration: line-through; font-style: italic;">${originalPrice}</span></h3>
                            <h3>GIÁ KHUYẾN MÃI : <span style="font-weight: bolder; font-style: italic;">${salePrice}</span></h3>
                        </div>

                        <h4 id="color">Màu sắc: XANH LÁ</h4>
                        <div id="listColor_pdt" class="listColor">
                            <div onclick="clickC_1(this,'${e.colorr1}','${
    e.img1
  }')" class="itemColor1" data-src="${e.img1}" style="background-color: ${
    e.colorr1
  };"></div>
                            <div onclick="clickC_1(this,'${e.colorr2}','${
    e.img2
  }')" class="itemColor2" data-src="${e.img2}" style="background-color: ${
    e.colorr2
  };"></div>
                            <div onclick="clickC_1(this,'${e.colorr3}','${
    e.img3
  }')" class="itemColor3" data-src="${e.img3}" style="background-color: ${
    e.colorr3
  };"></div>
                        </div>
                        <div class="countProduct">
                            <h4>Số lượng: </h4>
                            <i class="fa-solid fa-minus" onclick='reduce(${JSON.stringify(
                              e
                            )});'></i>
                            <input type="text"  readonly="readonly" id="counteInp" value="1">
                            <i class="fa-solid fa-plus" onclick='increase(${JSON.stringify(
                              e
                            )});'></i>
                        </div>
                        <div class="choiceSize">
                            <h3>Size: </h3>
                            <select name="" id="size">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div class="addToCart">
                            <p onclick="addShopingBag(objcolorcurrent)">Thêm vào giỏ</p>
                        </div>
                        <div class="content_infoProduct">
                            <h3>THÔNG TIN SẢN PHẨM</h3>
                            <span id="contentInfo">${e.nameSP}
                                <br>
                                MATERIAL: LÌ VEN ORIGINAL - Phiên bản bề mặt vải không đổ lông mang cảm giác thoáng mát
                                <br>
                                SIZE: A/B/C/D
                                <br>
                                Sản phẩm thuộc Special Collection “Make everything popular” DORAEMON | LEVENTS®
                            </span>
                        </div>
                        <div class="content_guideSize">
                            <h3>QUY ƯỚC KÍCH THƯỚC</h3>
                            <span id="contentGuide">Form áo được Fit size theo form và tiêu chuẩn tương đối của người Việt Nam, nếu bạn đang cân nhắc giữa hai size, nên chọn size lớn hơn.
                                <ul>
                                    <li>Size A: Chiều cao từ 1m50 - 1m65, cân nặng trên 55kg</li>
                                    <li>Size B: Chiều cao từ 1m65 - 1m72, cân nặng dưới 65kg</li>
                                    <li>Size C: Chiều cao từ 1m70 - 1m77, cân nặng dưới 80kg </li>
                                    <li>Size D: Chiều cao trên 1m72, cân nặng dưới 95kg.</li>
                                </ul>
                                <img src="./img/SizeChart.jpg" alt="">
                                <div class="back" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i>Trở Lại</div>
                            </span>
                        </div>
                    </div>
                </div>
            </div>`;
  document.getElementsByClassName("both")[0].innerHTML = s;
  document.getElementById("size").addEventListener("click", resetsize);
}

let quantity = "";

function reduce(itemJSON) {
  let count = document.querySelector("#counteInp");
  quantity = parseInt(count.value);
  let size = document.querySelector("#size").value;
  let Quantity = itemJSON.quantity;
  // console.log(Quantity);
  let maxQuantity = "";
  switch (size) {
    case "A":
      maxQuantity = Quantity.A;
      break;
    case "B":
      maxQuantity = Quantity.B;
      break;
    case "C":
      maxQuantity = Quantity.C;
      break;
    case "D":
      maxQuantity = Quantity.D;
      break;
  }
  if (quantity > 0) {
    quantity = quantity - 1;
  } else {
    quantity = maxQuantity;
  }
  count.value = quantity;
}

function increase(itemJSON) {
  let count = document.querySelector("#counteInp");
  quantity = parseInt(count.value);
  let size = document.querySelector("#size").value;
  let Quantity = itemJSON.quantity;
  // console.log(Quantity);
  let maxQuantity = "";
  switch (size) {
    case "A":
      maxQuantity = Quantity.A;
      break;
    case "B":
      maxQuantity = Quantity.B;
      break;
    case "C":
      maxQuantity = Quantity.C;
      break;
    case "D":
      maxQuantity = Quantity.D;
      break;
  }
  if (quantity < maxQuantity) {
    quantity = quantity + 1;
  } else {
    quantity = maxQuantity;
  }
  count.value = quantity;
}
function resetsize() {
  let count = document.querySelector("#counteInp");
  count.value = 0;
}
//doi mau sac quan ao trong chi textIndent
function clickC_1(e, color, img) {
  objcolorcurrent.color = color;
  objcolorcurrent.img = img;
  console.log(objcolorcurrent);
  const dataimg = e.getAttribute("data-src");
  const srcold = e.closest(".both_").querySelector(".srcimg"); //tim phan tu cha -> con co class srcimg
  srcold.setAttribute("src", dataimg);
}
function timkiemSP(arr, id) {
  for (let i = 0; i < arr.length; i++) {
    if (id == arr[i].idproduct) {
      return arr[i];
    }
  }
  return null;
}
function reloadpage() {
  const urlParams = new URLSearchParams(window.location.search);
  const productid = urlParams.get("productID");
  const item = timkiemSP(ProductArrBoth, productid);
  if (item) {
    loadSingleProduct(item);
  }
}

//nut tro lai
function goBack() {
  window.location.href = "shop.html";
}

let Product = JSON.parse(localStorage.getItem("arrayproducts"));
let arrayshopbag = [];
function getarrayshopbag() {
  let usercurrent = JSON.parse(localStorage.getItem("currentUser"));
  if (usercurrent != null) {
    let alluser = JSON.parse(localStorage.getItem("storageUsers"));
    for (let i = 0; i < alluser.length; i++) {
      if (alluser[i].userID == usercurrent.userID) {
        usercurrent = alluser[i];
      }
    }
    localStorage.setItem("currentUser", JSON.stringify(usercurrent));
    arrayshopbag = usercurrent.shopbag || [];
    localStorage.setItem("arrayshopbag", JSON.stringify(arrayshopbag));
    localStorage.setItem(
      "countarrayshopbag",
      JSON.stringify(arrayshopbag.length)
    );
  }
}
getarrayshopbag();
let soluong = 0; // Số lượng sản phẩm trong giỏ hàng
let tongtien = 0; // Tổng tiền của giỏ hàng
function updateAlluser(user) {
  let alluser = JSON.parse(localStorage.getItem("storageUsers"));
  for (let i = 0; i < alluser.length; i++) {
    if (alluser[i].userID == user.userID) {
      alluser[i].shopbag = user.shopbag;
    }
  }
  localStorage.setItem("storageUsers", JSON.stringify(alluser));
}
function updatecurrentuser() {
  usercurrent = JSON.parse(localStorage.getItem("currentUser"));
  usercurrent.shopbag = arrayshopbag;
  localStorage.setItem("currentUser", JSON.stringify(usercurrent));
  updateAlluser(usercurrent);
}
// Hiển thị thông tin giỏ hàng
function shopinginfo() {
  let arrayshopbag = JSON.parse(localStorage.getItem("arrayshopbag"));
  const cart = document.querySelector(".cart");
  let s = `<div class="shoping-bag">
        <div class="shoping-bag-header">
          <h3>Giỏ hàng</h3>
          <div class="close-shopping" onclick="closeall()">Đóng</div>
        </div>
        <div class="shoping-bag-info">`;

  // Hiển thị các sản phẩm trong giỏ hàng
  for (let i = 0; i < arrayshopbag.length; i++) {
    s += `<div class="shoping-bag-info-item">
            <div class="shoping-bag-img">
              <img src="${arrayshopbag[i].img}" alt="" />
            </div>
            <div class="cart-info">
              <h4>${arrayshopbag[i].obj.nameSP}</h4>
              <h6>${arrayshopbag[i].color}-${arrayshopbag[i].size}</h6>
              <div class="priceAndCount">
                <div class="count">
                  <i class="fa-solid fa-minus sub" onclick='reduceShopBag(${i});'></i>
                  <input type="text" readonly="readonly" class="countProductbuy" value="${arrayshopbag[i].soluong}" />
                  <i class="fa-solid fa-plus add" onclick='increaseShopBag(${i},"${arrayshopbag[i].size}");'></i>
                </div>
                <div class="price">${arrayshopbag[i].obj.price}₫</div>
              </div>
              <div class="delete effect-for-btn" onclick="removeItem(${i})">Xoá</div>
            </div>
          </div>`;
  }
  s += `</div>
        <div class="pay">
          <div class="main">
            <div class="info_bill">
              <div class="selected">
                <p>ĐÃ CHỌN:</p>
                <p id="totalCount">${soluong}</p>
              </div>
              <div class="discount">
                <p>KHUYẾN MÃI:</p>
                <p id="discountPercent"></p>
              </div>
              <div class="total">
                <p>TẠM TÍNH:</p>
                <p id="totalBill">${tongtien}₫</p>
              </div>
            </div>
            <div class="btn-pay">
              <h3 class="effect-for-btn buttonsubmit" onclick="giaodienthanhtoan();" >Xác nhận</h3>
            </div>
          </div>
        </div>
      </div>`;

  cart.innerHTML = s;
  cart.classList.add("active");
  chitiethoadon(); // Cập nhật lại thông tin giỏ hàng
}
function giaodienthanhtoan() {
  let arrayproducts = JSON.parse(localStorage.getItem("arrayshopbag")) || [];
  if (arrayproducts.length == 0) {
    alert("Giỏ hàng rỗng");
  } else {
    let tongtien = 0;
    getarrayshopbag();
    let usercurrent = JSON.parse(localStorage.getItem("currentUser"));
    document.querySelector(".cart").classList.remove("active");
    document.querySelector(".backgroud-menu-respon").style.display = "none";
    let s = `<h1 class="tittleheader">THÔNG TIN GIAO HÀNG</h1>
    <div class="infoCustomer box">
      <div class="infoCustomer-body">
        <div class="contentTab">
          <span>Họ và tên: </span>
          <input
            type="text"
            class="input"
            id="name"
            value="${usercurrent.name}"
            readonly
          />
        </div>
        <div class="contentTab">
          <span>Số điện thoại: </span>
          <input
            type="text"
            class="input"
            id="phone"
            value="${usercurrent.phone}"
            readonly
          />
        </div>
        <div class="contentTab">
          <span>Địa chỉ : </span>
          <input type="text" class="input" id="address" value="${usercurrent.diachi}" readonly />
        </div>
        <div id="buttonEdit" onclick="chinhsua();">Chỉnh sửa</div>
      </div>
    </div>
    <div class="payment box">
      <div class="viewCart">
        <div class="titleCol">
          <span class="idProduct">ID</span>
          <span class="imgProduct">Hình ảnh</span>
          <span class="nameProduct">Tên sản phẩm</span>
          <span class="colorProduct">Màu sắc</span>
          <span class="countProduct">Số lượng</span>
          <span class="priceProduct">Đơn giá</span>
        </div>
        <div id="viewCart-body">`;
    for (let i = 0; i < arrayshopbag.length; i++) {
      tongtien +=
        parseInt(arrayshopbag[i].obj.price) * parseInt(arrayshopbag[i].soluong);
      s += `<div class="product">
            <span class="idProduct">${arrayshopbag[i].obj.idproduct}</span>
            <span class="imgProduct imgsp"
              ><img src="${arrayshopbag[i].img}" alt=""
            /></span>
            <span class="nameProduct">${arrayshopbag[i].obj.nameSP}</span>
            <span class="colorProduct">${arrayshopbag[i].color}</span>
            <span class="countProduct">${arrayshopbag[i].soluong}</span>
            <span class="priceProduct">${arrayshopbag[i].obj.price}</span>
          </div>`;
    }
    s += `</div>
      </div>
      <div class="methodPayment">
        <h4>Phương thức thanh toán</h4>
        <div class="method">
          <input type="radio" name="radio" id="" checked />
          <span>
            <i class="now-ui-icons shopping_credit-card"></i>Thẻ tín dụng / Thẻ
            ghi nợ</span
          >
        </div>
        <div class="method">
          <input type="radio" name="radio" id="" />
          <span
            ><i class="now-ui-icons shopping_delivery-fast"></i>Thanh toán khi
            nhận hàng</span
          >
        </div>
        <div class="infoBill">
          <div class="contentTab">
            <span>Tạm tính:</span>
            <span id="valueTemporary">${tongtien}</span>
          </div>
          <div class="contentTab">
            <span>Tổng:</span>
            <span id="valueBill">${tongtien}</span>
          </div>
        </div>
      </div>
      <div class="buttonsubmit" onclick="thanhtoan()">Thanh toán</div>
    </div>`;
    midcontent.innerHTML = s;
  }
}
// Tính toán số lượng và tổng tiền của giỏ hàng
function chitiethoadon() {
  let arrayshopbag = JSON.parse(localStorage.getItem("arrayshopbag"));
  soluong = 0;
  tongtien = 0;
  for (let i = 0; i < arrayshopbag.length; i++) {
    soluong += parseInt(arrayshopbag[i].soluong);
    tongtien +=
      parseInt(arrayshopbag[i].obj.price) * parseInt(arrayshopbag[i].soluong);
  }

  const totalCountElement = document.getElementById("totalCount");
  const totalBillElement = document.getElementById("totalBill");

  if (totalCountElement) {
    totalCountElement.textContent = soluong;
  }
  if (totalBillElement) {
    totalBillElement.textContent = tongtien + "₫";
  }
}

// Giảm số lượng sản phẩm trong giỏ hàng
function reduceShopBag(index) {
  let count = document.querySelectorAll(".countProductbuy")[index];
  let quantity = parseInt(count.value);

  if (quantity > 1) {
    quantity--;
    count.value = quantity;
    arrayshopbag[index].soluong = quantity; // Cập nhật lại số lượng trong giỏ hàng
    localStorage.setItem("arrayshopbag", JSON.stringify(arrayshopbag)); // Lưu lại giỏ hàng
    updatecurrentuser();
    chitiethoadon(); // Cập nhật lại thông tin giỏ hàng
  }
}

// Tăng số lượng sản phẩm trong giỏ hàng
function increaseShopBag(index, sizeproduct) {
  let count = document.querySelectorAll(".countProductbuy")[index];
  let quantity = parseInt(count.value);
  // console.log(arrayshopbag[index].obj.quantity.A);
  let Quantity = arrayshopbag[index].obj.quantity; // Giới hạn số lượng tối đa
  let maxQuantity = "";
  switch (sizeproduct) {
    case "A":
      maxQuantity = Quantity.A;
      break;
    case "B":
      maxQuantity = Quantity.B;
      break;
    case "C":
      maxQuantity = Quantity.C;
      break;
    case "D":
      maxQuantity = Quantity.D;
      break;
  }
  if (quantity < maxQuantity) {
    quantity++;
    count.value = quantity;
    arrayshopbag[index].soluong = quantity; // Cập nhật lại số lượng trong giỏ hàng
    localStorage.setItem("arrayshopbag", JSON.stringify(arrayshopbag)); // Lưu lại giỏ hàng
    updatecurrentuser();
    chitiethoadon(); // Cập nhật lại thông tin giỏ hàng
  }
}

// Xóa sản phẩm khỏi giỏ hàng
function removeItem(index) {
  getarrayshopbag();
  arrayshopbag.splice(index, 1);
  let soluongspgiohang = arrayshopbag.length;

  if (soluongspgiohang > 0) {
    document.querySelector(".Shoping span").textContent = soluongspgiohang;
    document.querySelector(".Shoping").style.color = "red";
  } else {
    document.querySelector(".Shoping span").textContent = 0;
    document.querySelector(".Shoping").style.color = "black";
  }
  localStorage.setItem("arrayshopbag", JSON.stringify(arrayshopbag));
  updatecurrentuser();
  localStorage.setItem("countarrayshopbag", JSON.stringify(soluongspgiohang));
  shopinginfo(); // Cập nhật lại giỏ hàng hiển thị
}

// Đóng giỏ hàng
function closeall() {
  document.querySelector(".cart").classList.remove("active");
  document.querySelector(".backgroud-menu-respon").style.display = "none";
}

// Mở giỏ hàng
const shoping = document.querySelectorAll(".Shoping");
shoping.forEach(function (e) {
  e.addEventListener("click", () => {
    const bag = document.querySelector(".cart");
    bag.classList.add("active");
    document.querySelector(".backgroud-menu-respon").style.display = "block";
    shopinginfo(); // Hiển thị thông tin giỏ hàng khi mở
  });
});

// Thêm sản phẩm vào giỏ hàng
function kiemtradangnhap() {
  let user = JSON.parse(localStorage.getItem("currentUser"));
  return user !== null;
}
let soluongspgiohang =
  JSON.parse(localStorage.getItem("countarrayshopbag")) || 0;
if (soluongspgiohang > 0) {
  document.querySelector(".Shoping span").textContent = soluongspgiohang;
  document.querySelector(".Shoping").style.color = "red";
} else {
  document.querySelector(".Shoping span").textContent = 0;
  document.querySelector(".Shoping").style.color = "black";
}
function kiemtradacotronggiohang(item) {
  arrayshopbag = JSON.parse(localStorage.getItem("arrayshopbag"));
  for (let i = 0; i < arrayshopbag.length; i++) {
    if (
      item.obj.idproduct == arrayshopbag[i].obj.idproduct &&
      item.size == arrayshopbag[i].size &&
      item.color == arrayshopbag[i].color
    ) {
      return arrayshopbag[i];
    }
  }
  return null;
}
// Utility function to check stock availability
function kiemtraconhang(item) {
  let products = JSON.parse(localStorage.getItem("arrayproducts"));
  for (let i = 0; i < products.length; i++) {
    if (products[i].idproduct === item.obj.idproduct) {
      switch (item.size) {
        case "A":
          return products[i].quantity.A > 0;
        case "B":
          return products[i].quantity.B > 0;
        case "C":
          return products[i].quantity.C > 0;
        case "D":
          return products[i].quantity.D > 0;
      }
    }
  }
  return false;
}

function addShopingBag(item) {
  let toast = document.querySelector(".toast_info");
  if (kiemtradangnhap() === true) {
    item.size = document.querySelector("#size").value;
    item.soluong = parseInt(document.querySelector("#counteInp").value);

    // Check if the selected size is in stock
    if (!kiemtraconhang(item)) {
      alert("Size " + item.size + " đã hết hàng");
      return;
    }

    getarrayshopbag();
    soluongspgiohang = arrayshopbag.length;

    // Check if the product already exists in the shopping bag
    let existingItem = kiemtradacotronggiohang(item);
    if (existingItem != null) {
      // Check if adding the new quantity would exceed the available stock
      let products = JSON.parse(localStorage.getItem("arrayproducts"));
      let product = products.find((p) => p.idproduct === item.obj.idproduct);
      let availableStock = product.quantity[item.size];
      if (existingItem.soluong + item.soluong > availableStock) {
        alert("Không đủ hàng trong kho");
        return;
      } else {
        existingItem.soluong += item.soluong;
      }
    } else {
      arrayshopbag.push(item);
      soluongspgiohang++;
    }

    localStorage.setItem("arrayshopbag", JSON.stringify(arrayshopbag)); // Save the shopping bag
    updatecurrentuser();
    localStorage.setItem("countarrayshopbag", JSON.stringify(soluongspgiohang));

    // Update the display of the number of products in the shopping bag
    updateshopingbag();
    chitiethoadon(); // Update the shopping bag details
  } else {
    alert("Vui lòng đăng nhập");
  }
}

// Update the display of the number of products in the shopping bag when the page is loaded
function updateshopingbag() {
  soluongspgiohang = JSON.parse(localStorage.getItem("countarrayshopbag")) || 0;
  if (soluongspgiohang > 0) {
    document.querySelector(".Shoping span").textContent = soluongspgiohang;
    document.querySelector(".Shoping").style.color = "red";
  } else {
    document.querySelector(".Shoping span").textContent = "0";
    document.querySelector(".Shoping").style.color = "black";
  }
}

// Initial call to update the shopping bag display
updateshopingbag();

// Cập nhật số lượng sản phẩm trong giỏ hàng khi trang được tải
function updateshopingbag() {
  soluongspgiohang = JSON.parse(localStorage.getItem("countarrayshopbag")) || 0;
  if (soluongspgiohang > 0) {
    document.querySelector(".Shoping span").textContent = soluongspgiohang;
    document.querySelector(".Shoping").style.color = "red";
  } else {
    document.querySelector(".Shoping span").textContent = "0";
    document.querySelector(".Shoping").style.color = "black";
  }
}

function dieuchinhsoluongtrongkho(arr) {
  console.log(arr);
  let products = JSON.parse(localStorage.getItem("arrayproducts"));
  for (let i = 0; i < products.length; i++) {
    for (let j = 0; j < arr.length; j++) {
      if (arr[j].obj.idproduct == products[i].idproduct) {
        // console.log(arr[j].obj.idproduct, products[i].idproduct);
        switch (arr[j].size) {
          case "A":
            products[i].quantity.A =
              parseInt(products[i].quantity.A) - parseInt(arr[j].soluong);
            break;
          case "B":
            products[i].quantity.B =
              parseInt(products[i].quantity.B) - parseInt(arr[j].soluong);
            break;
          case "C":
            products[i].quantity.C =
              parseInt(products[i].quantity.C) - parseInt(arr[j].soluong);
            break;
          case "D":
            products[i].quantity.D =
              parseInt(products[i].quantity.D) - parseInt(arr[j].soluong);
            break;
        }
      }
    }
  }
  localStorage.setItem("arrayproducts", JSON.stringify(products));
}

function kiemtratontai(IDuser) {
  let shopbagispay = JSON.parse(localStorage.getItem("shopbagispay")) || [];
  for (let i = 0; i < shopbagispay.length; i++) {
    if (shopbagispay[i].IDuser == IDuser) {
      return i;
    }
  }
  return null;
}

function thanhtoan() {
  let shopbagispay = JSON.parse(localStorage.getItem("shopbagispay")) || [];
  let usercurrent = JSON.parse(localStorage.getItem("currentUser"));
  let userIndex = kiemtratontai(usercurrent.userID);

  if (usercurrent.phone === "" || usercurrent.diachi === "") {
    alert("Vui lòng nhập đầy đủ số điện thoại và địa chỉ");
    chinhsua();
  } else {
    if (userIndex !== null) {
      let arrayshopbag = JSON.parse(localStorage.getItem("arrayshopbag")) || [];
      for (let i = 0; i < arrayshopbag.length; i++) {
        shopbagispay[userIndex].shopbagispayuser.push(arrayshopbag[i]);
      }
    } else {
      let shopbagitem = {
        IDuser: usercurrent.userID,
        shopbagispayuser:
          JSON.parse(localStorage.getItem("arrayshopbag")) || [],
      };
      shopbagispay.push(shopbagitem);
    }

    localStorage.setItem("shopbagispay", JSON.stringify(shopbagispay));

    // Ensure the correct list of items is passed for inventory adjustment
    let itemsToAdjust =
      userIndex !== null
        ? shopbagispay[userIndex].shopbagispayuser
        : JSON.parse(localStorage.getItem("arrayshopbag"));

    dieuchinhsoluongtrongkho(itemsToAdjust);

    // Clear user's shopping bag after checkout
    let alluser = JSON.parse(localStorage.getItem("storageUsers"));
    for (let i = 0; i < alluser.length; i++) {
      if (alluser[i].userID == usercurrent.userID) {
        alluser[i].shopbag = [];
        usercurrent.shopbag = [];
      }
    }
    localStorage.setItem("storageUsers", JSON.stringify(alluser));
    localStorage.setItem("currentUser", JSON.stringify(usercurrent));
    // Reload the page to reflect changes
    location.reload();
  }
}

let isEditing = false; // Flag to track edit state

function chinhsua() {
  const editButton = document.querySelector("#buttonEdit"); // Get the edit button
  const inputEdit = document.querySelectorAll(".input"); // Get all input fields
  let usercurrent = JSON.parse(localStorage.getItem("currentUser"));
  const phone = document.querySelector("#phone");
  const address = document.querySelector("#address");

  if (editButton != null) {
    editButton.addEventListener("click", () => {
      if (isEditing) {
        // Save mode
        inputEdit.forEach(function (e) {
          e.setAttribute("readonly", true);
          e.classList.remove("active"); // Remove active class when saving
        });
        editButton.textContent = "Chỉnh sửa";
        // Save updated user information
        usercurrent.phone = phone.value;
        usercurrent.diachi = address.value;
        localStorage.setItem("currentUser", JSON.stringify(usercurrent));
        updateUserDetails(usercurrent); // Update the user details in storageUsers
      } else {
        // Edit mode
        inputEdit.forEach(function (e) {
          e.removeAttribute("readonly");
          e.classList.add("active"); // Add active class when editing
        });
        editButton.textContent = "Lưu lại";
      }
      // Toggle edit state
      isEditing = !isEditing;
    });
  }
}

// Function to update user details in storageUsers
function updateUserDetails(user) {
  let allUsers = JSON.parse(localStorage.getItem("storageUsers")) || [];
  for (let i = 0; i < allUsers.length; i++) {
    if (allUsers[i].userID == user.userID) {
      allUsers[i] = user;
      break;
    }
  }
  localStorage.setItem("storageUsers", JSON.stringify(allUsers));
}

// Initialize the edit function
chinhsua();
makeFilter();
makeSP(getCurrentPage(), sosptrongtrang);
makeselectpage(getCurrentPage(), ProductArrBoth);
// saveArraytolocal();
