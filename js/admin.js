let Productindex = [
  {
    nameSP: "LEVENTS® | DORAEMON FAMOUS CAT TEE",
    img: "./img/products/p1-1.png",
    price: 370000,
    nametag: "aothun#",
    idproduct: "abc",
    colorr1: "green",
    colorr2: "red",
    colorr3: "unset",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    img1: "./img/products/p1-1.png",
    img2: "./img/products/p1-2.jpg",
    img3: "./img/products/p1-2.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON COLLAB TEE",
    img: "./img/products/p2-1.png",
    price: 450000,
    nametag: "aothun#",
    idproduct: "",
    colorr1: "white",
    colorr2: "black",
    colorr3: "unset",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    img1: "./img/products/p2-1.png",
    img2: "./img/products/p2-2.png",
    img3: "./img/products/p2-2.png",
  },
  {
    nameSP: "LEVENTS® DINOSAUR TEE",
    img: "./img/products/p3-1.jpg",
    price: 420000,
    nametag: "aothun#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " white",
    colorr2: "black",
    colorr3: "blue",
    img1: "./img/products/p3-1.jpg",
    img2: "./img/products/p3-2.jpg",
    img3: "./img/products/p3-3.jpg",
  },
  {
    nameSP: "LEVENTS® INSIDE OUT TEE",
    img: "./img/products/p4-1.jpg",
    price: 390000,
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    nametag: "aothun#",
    idproduct: "",
    colorr1: " white",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p4-1.jpg",
    img2: "./img/products/p4-2.jpg",
    img3: "./img/products/p4-2.jpg",
  },
  {
    nameSP: "LEVENTS® LOVEYOU300K SPECIAL TEE",
    img: "./img/products/p5-1.jpg",
    price: 300000,
    nametag: "aothun#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " white",
    colorr2: "unset",
    idproduct: "",
    colorr3: "unset",
    img1: "./img/products/p5-1.jpg",
    img2: "./img/products/p5-1.jpg",
    img3: "./img/products/p5-1.jpg",
  },
  {
    nameSP: "LEVENTS® FUNNY CROCODILE TEE",
    img: "./img/products/p6-1.jpg",
    price: 390000,
    nametag: "aothun#",
    colorr1: "blue",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr2: "green",
    colorr3: "unset",
    img1: "./img/products/p6-1.jpg",
    img2: "./img/products/p6.jpg",
    img3: "./img/products/p6-2.jpg",
  },
  {
    nameSP: "LEVENTS® PUNCH VARSITY",
    img: "./img/products/p7-1.jpg",
    price: 890000,
    nametag: "aokhoac#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: "green",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p7-1.jpg",
    img2: "./img/products/p7-2.jpg",
    img3: "./img/products/p7-2.jpg",
  },
  {
    nameSP: "LEVENTS® SELFLOVE BOXY TEE",
    img: "./img/products/p8-1.jpg",
    price: 380000,
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    nametag: "aothun#",
    colorr1: " white",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p8-1.jpg",
    img2: "./img/products/p8-2.jpg",
    img3: "./img/products/p8-1.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON MINI CAT Polo",
    img: "./img/products/p9-1.jpg",
    price: 405000,
    nametag: "polo#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr1: " white",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p9-1.jpg",
    img2: "./img/products/p9-2.jpg",
    img3: "./img/products/p9-2.jpg",
  },
  {
    nameSP: "LEVENTS® MINI POPULAR Polo",
    img: "./img/products/p10-1.jpg",
    price: 370000,
    nametag: "polo#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr1: " white",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p10-1.jpg",
    img2: "./img/products/p10-2.jpg",
    img3: "./img/products/p10-2.jpg",
  },
  {
    nameSP: "LEVENTS® STRIPE Polo",
    img: "./img/products/p11-1.jpg",
    price: 420000,
    idproduct: "",
    nametag: "polo#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " white",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p11-1.jpg",
    img2: "./img/products/p11-2.jpg",
    img3: "./img/products/p11-2.jpg",
  },
  {
    nameSP: "LEVENTS® CINEMA SHIRT",
    img: "./img/products/p12-1.jpg",
    price: 420000,
    nametag: "somi#",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr1: "green",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p12-1.jpg",
    img2: "./img/products/p12-2.jpg",
    img3: "./img/products/p12-2.jpg",
  },
  {
    nameSP: "LEVENTS® CITIES SHIRT",
    img: "./img/products/p13-1.jpg",
    price: 420000,
    nametag: "somi#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " white",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p13-1.jpg",
    img2: "./img/products/p13-2.jpg",
    img3: "./img/products/p13-2.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON COLLAB ZIPPER Hoodie",
    img: "./img/products/p14-1.jpg",
    price: 645000,
    nametag: "hoodie#",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr1: " white",
    colorr2: "gray",
    colorr3: "unset",
    img1: "./img/products/p14-1.jpg",
    img2: "./img/products/p14-2.jpg",
    img3: "./img/products/p14-2.jpg",
  },
  {
    nameSP: "LEVENTS® POPULAR LOGO 2.0 Hoodie",
    img: "./img/products/p15-1.jpg",
    price: 590000,
    nametag: "hoodie#",
    colorr1: "pink",
    colorr2: "green",
    idproduct: "",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr3: "black",
    img1: "./img/products/p15-1.jpg",
    img2: "./img/products/p15-2.jpg",
    img3: "./img/products/p15-3.jpg",
  },
  {
    nameSP: "LEVENTS® MINI LOGO ZIPPER Hoodie",
    img: "./img/products/p16-1.jpg",
    price: 620000,
    nametag: "hoodie#",
    colorr1: " white",
    colorr2: "gray",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr3: "unset",
    idproduct: "",
    img1: "./img/products/p16-1.jpg",
    img2: "./img/products/p16-2.jpg",
    img3: "./img/products/p16-2.jpg",
  },
  {
    nameSP: "LEVENTS® | DORAEMON COLLAB Hoodie",
    img: "./img/products/p17-1.jpg",
    price: 620000,
    nametag: "hoodie#",
    colorr1: " white",
    colorr2: "black",
    colorr3: "unset",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    img1: "./img/products/p17-1.jpg",
    img2: "./img/products/p17-2.jpg",
    img3: "./img/products/p17-2.jpg",
  },
  {
    nameSP: "LEVENTS® BASIC Sweater",
    img: "./img/products/p18-1.jpg",
    price: 490000,
    nametag: "sweater#",
    idproduct: "",
    colorr1: "gray",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    colorr2: "red",
    colorr3: "unset",
    img1: "./img/products/p18-1.jpg",
    img2: "./img/products/p18-2.jpg",
    img3: "./img/products/p18-2.jpg",
  },
  {
    nameSP: "LEVENTS® FUNNY CROCODILE Sweater",
    img: "./img/products/p19-1.jpg",
    price: 490000,
    nametag: "sweater#",
    colorr1: "green",
    quantity: {
      A: 5,
      B: 4,
      C: 6,
      D: 2,
    },
    idproduct: "",
    colorr2: "black",
    colorr3: "unset",
    img1: "./img/products/p19-1.jpg",
    img2: "./img/products/p19-2.jpg",
    img3: "./img/products/p19-2.jpg",
  },
];
if (JSON.parse(localStorage.getItem("arrayproducts")) == null) {
  localStorage.setItem("arrayproducts", JSON.stringify(Productindex));
}
let ArrProduct = JSON.parse(localStorage.getItem("arrayproducts"));
let sell = JSON.parse(localStorage.getItem("shopbagispay")) || [];
localStorage.setItem("currentUser", JSON.stringify(null));
let Arrll = sell.flatMap((i) => i.shopbagispayuser);
localStorage.setItem("arrayshopbag", JSON.stringify(null));
localStorage.setItem("countarrayshopbag", JSON.stringify(null));
let Arrsell = [];

let typeproducts = [
  { typeid: "aothun#", typename: "Áo thun" },
  { typeid: "polo#", typename: "Polo" },
  { typeid: "somi#", typename: "Sơ mi" },
  { typeid: "hoodie#", typename: "Hoodie" },
  { typeid: "sweater#", typename: "Sweater" },
  { typeid: "aokhoac#", typename: "Áo khoác" },
];
localStorage.setItem("typeproduct", JSON.stringify(typeproducts));

function toast({ title = "", message = "", type = "", duration = 5000 }) {
  const main = document.getElementById("toast");
  if (main) {
    const toast = document.createElement("div");
    toast.onclick = function (e) {
      if (e.target.closest(".toast__close")) {
        main.removeChild(toast);
      }
    };

    const icons = {
      success: "fa-solid fa-circle-check",
      error: "fa-solid fa-circle-exclamation",
    };
    const icon = icons[type];

    toast.classList.add("toast", `toast--${type}`);
    toast.innerHTML = `
        <div class="toast__icon">
          <i class="${icon}"></i>
        </div>
        <div class="toast__body">
          <h3 class="toast__title">${title}</h3>
          <p class="toast__msg">${message}</p>
        </div>
        <div class="toast__close">
          <i class="fa-solid fa-xmark"></i>
        </div>
    `;
    main.appendChild(toast);
  }
}

function makeIDproduct() {
  let ArrProducts = JSON.parse(localStorage.getItem("arrayproducts")) || [];
  for (let i = 0; i < ArrProduct.length; i++) {
    ArrProducts[i].idproduct = ArrProducts[i].nametag + i;
  }
  localStorage.setItem("arrayproducts", JSON.stringify(ArrProducts));
}
//----------------sp-------------------------
function productSatus(ArrProducts) {
  ArrProducts.forEach((i) => {
    let count = i.quantity.A + i.quantity.B + i.quantity.C + i.quantity.D;
    let status = "C.XÁC ĐỊNH";
    let colorStatus = "#000";
    if (count > 10) {
      status = "CÒN HÀNG";
      colorStatus = "#32CD32";
    } else if (count == 0) {
      status = "HẾT HÀNG";
      colorStatus = "#EE4B2B";
    } else if (count <= 10) {
      status = "SẮP HẾT";
      colorStatus = "#FDDA0D";
    }
    i.status = status;
    i.colorStatus = colorStatus;
  });
  localStorage.setItem("arrayproducts", JSON.stringify(ArrProducts));
}

function listSP(arr) {
  let s = "";
  arr.forEach((product) => {
    let count =
      product.quantity.A +
      product.quantity.B +
      product.quantity.C +
      product.quantity.D;
    const Price = product.price.toLocaleString("vi-VN", {
      style: "currency",
      currency: "VND",
    });
    s += `
           <div oncontextmenu="showContextMenu(event, this)" class="list">
                <span style="width: 10%" nametag ="${product.nametag}" class="idProduct">${product.idproduct}</span>
                <img style="width: 20%" src="${product.img}" class="imgProduct" alt="Ảnh">
                <span style="width: 30%" class="nameProduct">${product.nameSP}</span>
                <span style="width: 10%" data="${product.colorr1}" class="colorProduct">${product.colorr1}</span>
                <span style="width: 10%" dataA="${product.quantity.A}" dataB="${product.quantity.B}" dataC="${product.quantity.C}" dataD="${product.quantity.D}" class="countProduct">${count}</span>
                <span style="width: 10%" dataPrice="${product.price}" class="priceProduct">${Price}</span>
                <span style="width: 10% ; color :${product.colorStatus}"; class="statusProduct">${product.status}</span>
            </div>
    `;
  });
  return s;
}

function countProduct(arr) {
  return arr.length;
}

function searchSP() {
  let filteredProducts = JSON.parse(localStorage.getItem("arrayproducts"));
  productSatus(filteredProducts);
  const comboType = document.getElementById("comboType").value;
  const comboStatus = document.getElementById("comboStatus").value;
  if (comboType !== "0") {
    filteredProducts = filteredProducts.filter(
      (product) => product.nametag === comboType
    );
  }
  if (comboStatus !== "0") {
    filteredProducts = filteredProducts.filter((product) => {
      if (comboStatus === "1") return product.status === "CÒN HÀNG";
      if (comboStatus === "2") return product.status === "SẮP HẾT";
      if (comboStatus === "3") return product.status === "HẾT HÀNG";
    });
  }
  document.querySelector("#storage-body").innerHTML = listSP(filteredProducts);
  document.querySelector("#amountOfProduct").innerText =
    countProduct(filteredProducts);
}

function renderqlsp() {
  document.querySelector(".page-right").innerHTML = `<div class="qlsp">
                <div class="title"><h1>QUẢN LÝ SẢN PHẨM</h1></div>
                <div class="btnAdd"><div class="circle" onclick="btnAdd()"><i class="fa-solid fa-plus"></i></div></div>
                <div class="groupOption">
                        <select name="" class="box" id="comboType" onchange="searchSP()" >
                            <option value="0">Tất cả</option>
                            <option value="aothun#">Áo thun</option>
                            <option value="polo#">Polo</option>
                            <option value="somi#">Sơ mi</option>
                            <option value="hoodie#">Hoodie</option>
                            <option value="sweater#">Sweater</option>
                            <option value="aokhoac#">Áo khoác</option>
                        </select>
                        <select name="" class="box" id="comboStatus" onchange="searchSP()" >
                            <option value="0">Tất cả</option>
                            <option value="1">CÒN HÀNG</option>
                            <option value="2">SẮP HẾT</option>
                            <option value="3">HẾT HÀNG</option>
                        </select>
                        <div class="box">
                            <div class="contentBox">
                                <div class="leftBox">
                                    <h2 id="amountOfProduct">0</h2>
                                    <span>SẢN PHẨM</span>
                                </div>
                                <i class="fa-solid fa-star"></i>
                            </div>
                        </div>
                </div>
                <div class="titleCol">
                    <span style="width: 10%" class="idProduct">ID</span>
                    <span style="width: 20% ; padding-left: 7%" class="imgProduct">Hình ảnh</span>
                    <span style="width: 30% ; padding-left: 5%" class="nameProduct">Tên sản phẩm</span>
                    <span style="width: 10%" class="colorProduct">Màu sắc</span>
                    <span style="width: 10%" class="countProduct">Số lượng</span>
                    <span style="width: 10%" class="priceProduct">Đơn giá</span>
                    <span style="width: 10%" class="statusProduct">Trạng thái</span>
                </div>
                <div id="storage-body"></div>`;
  searchSP();
}

// quan - chuot phai ------

function showContextMenu(event, element) {
  event.preventDefault();
  // Lấy vị trí chuột
  const posX = event.pageX;
  const posY = event.pageY;
  const contextMenu = document.getElementById("contextMenu");
  contextMenu.style.display = "block";
  contextMenu.style.left = `${posX}px`;
  contextMenu.style.top = `${posY}px`;

  let ArrProduct = JSON.parse(localStorage.getItem("arrayproducts"));

  const idProduct = element.querySelector(".idProduct").textContent;
  const img = element.querySelector(".imgProduct").src;
  const nameProduct = element.querySelector(".nameProduct").textContent;
  // const colorProduct = element.querySelector(".colorProduct").textContent;
  const codecolor = element.querySelector(".colorProduct").getAttribute("data");
  const countA = element.querySelector(".countProduct").getAttribute("dataA");
  const countB = element.querySelector(".countProduct").getAttribute("dataB");
  const countC = element.querySelector(".countProduct").getAttribute("dataC");
  const countD = element.querySelector(".countProduct").getAttribute("dataD");
  const price = element
    .querySelector(".priceProduct")
    .getAttribute("dataPrice");
  const nametag = element.querySelector(".idProduct").getAttribute("nametag");
  let typeProduct = "";
  switch (true) {
    case nametag.startsWith("hoodie#"):
      typeProduct = "Hoodie";
      break;
    case nametag.startsWith("sweater#"):
      typeProduct = "Sweater";
      break;
    case nametag.startsWith("somi#"):
      typeProduct = "Sơ mi";
      break;
    case nametag.startsWith("polo#"):
      typeProduct = "Polo";
      break;
    case nametag.startsWith("aothun#"):
      typeProduct = "Áo thun";
      break;
    case nametag.startsWith("aokhoac#"):
      typeProduct = "Áo khoác";
      break;
    default:
      typeProduct = "Không xác định";
  }
  //xoa san pham
  document.getElementById("deleteProduct").addEventListener("click", () => {
    toggleConfirmationDialog(true);
    document.querySelector(".outbackround").classList.add("actoutbackground");
    document.getElementById("yes").onclick = () => {
      for (let i = 0; i < countProduct(ArrProduct); i++) {
        if (ArrProduct[i].idproduct === idProduct) {
          ArrProduct.splice(i, 1); // 1 la vi tri roi
          i--;
          break;
        }
      }
      localStorage.setItem("arrayproducts", JSON.stringify(ArrProduct));
      renderqlsp();
      toggleConfirmationDialog(false);
      closeTabb();
      document
        .querySelector(".outbackround")
        .classList.remove("actoutbackground");
    };
    document.getElementById("no").onclick = () => {
      toggleConfirmationDialog(false);
      closeTabb();
      document
        .querySelector(".outbackround")
        .classList.remove("actoutbackground");
    };
  });

  //chinh sua
  document.getElementById("viewDetails").addEventListener("click", () => {
    document.querySelector(".outbackround").classList.add("actoutbackground");
    document.querySelector(".viewmenu").classList.add("actz");
    document.querySelector(".viewmenu").classList.remove("nonez");

    document.querySelector(".viewmenu").innerHTML = `<div id="tabAddProduct">
      <div class="headTab">
          <span class="title">CHỈNH SỬA</span>
          <span onclick ="closeTabz()" class="closeTab">ĐÓNG</span>
      </div>
      <form action="">
        <div class="bodyTab">
            <div class="leftTab">
                <div class="contentTab">
                    <span>ID: </span>
                    <span class="ID">${idProduct}</span>
                </div>
                <div class="contentTab">
                    <div id="imageContainer"> 
                      <img src="${img}" class="imgPreview">
                    </div>
                    <input type="file" name="file" id="file" class="inputfile" accept="image/*" onchange="onloandimg(this)">
                    <label style="margin-left:-75px;" for="file">Chọn ảnh</label>
                </div>
                    <div class="contentTab"> 
                        <span>Tên sản phẩm: </span>
                        <input style="width: 50%" type="text" placeholder="Tên sản phẩm" value="${nameProduct}" id="nameProduct_">
                    </div>
                    <div class="contentTab colorInput">
                        <span>Màu sắc: </span>
                        <select id="colorAddProduct_">
                                  
                        </select>
                    </div>
                    <div class="contentTab">
                        <span>Số lượngA: </span>
                        <input style="width: 20%" type="text" id="countProductA_" placeholder="Số lượng" value="${countA}">
                    </div>
            </div>
            <div class="rightTab">
                         <div class="contentTab">
                            <span>Số lượngB: </span>
                            <input style="width: 20%" type="text" id="countProductB_" placeholder="Số lượng" value="${countB}">
                        </div>
                         <div class="contentTab">
                            <span>Số lượngC: </span>
                            <input style="width: 20%" type="text" id="countProductC_" placeholder="Số lượng" value="${countC}">
                        </div>
                         <div class="contentTab">
                            <span>Số lượngD: </span>
                            <input style="width: 20%" type="text" id="countProductD_" placeholder="Số lượng" value="${countD}">
                        </div>
                        <div class="contentTab">
                            <span>Đơn giá: </span>
                            <input style="width: 30%" type="text" id="priceProduct_" placeholder="Đơn giá" value="${price}">
                        </div>
                        <div class="contentTab">
                            <span>Loai : </span>
                            <select id="typeproduct">
                            
                            </select>
                        </div>

            </div>
        </div>
        <div onclick="chinhsua()" class="btnAccept">
            <div class="content-btn">
                <buttom type="sumbit">HOÀN TẤT</buttom>
            </div>
        </div>
      </form>
  </div>`;
    tao_option_type(typeProduct, nametag);
    tao_mausac_(codecolor);
  });
}

function tao_mausac_(c) {
  let codecolor_ = [
    "red",
    "blue",
    "green",
    "yellow",
    "orange",
    "pink",
    "purple",
  ];
  let s = `<option value="${c}">${c}</option>`;
  codecolor_.forEach((i) => {
    if (i !== c) {
      s += `<option value="${i}">${i}</option>`;
    }
  });
  document.getElementById("colorAddProduct_").innerHTML = s;
}

function tao_option_type(p, v) {
  let s = `<option value="${v}">${p}</option>`;
  let typeproduct = JSON.parse(localStorage.getItem("typeproduct"));
  typeproduct.forEach((i) => {
    if (v !== i.typeid) {
      s += ` <option value="${i.typeid}">${i.typename}</option>`;
    }
  });
  document.querySelector("#typeproduct").innerHTML = s;
}

function chinhsua() {
  // Lấy lại dữ liệu từ localStorage
  let ArrProduct = JSON.parse(localStorage.getItem("arrayproducts")) || [];
  let background = document.querySelector(".outbackround");
  let l = document.querySelector(".btnAddproduct");
  l.classList.remove("actz");
  l.classList.add("nonez");
  background.classList.remove("actoutbackground");

  const id = document.querySelector(".ID").innerText;
  const nameProduct = document.getElementById("nameProduct_").value.trim();
  // const colorProduct = document.getElementById("colorAddProduct").value.trim();
  const codecolorProduct = document
    .getElementById("colorAddProduct_")
    .value.trim();
  const countProductA = parseInt(
    document.getElementById("countProductA_").value
  );
  const countProductB = parseInt(
    document.getElementById("countProductB_").value
  );
  const countProductC = parseInt(
    document.getElementById("countProductC_").value
  );
  const countProductD = parseInt(
    document.getElementById("countProductD_").value
  );
  const priceProduct = parseFloat(
    document.getElementById("priceProduct_").value
  );
  const nametagProduct = document.getElementById("typeproduct").value.trim();

  if (
    isNaN(countProductA) ||
    isNaN(countProductB) ||
    isNaN(countProductC) ||
    isNaN(countProductD) ||
    isNaN(priceProduct)
  ) {
    alert("VUI LONG NHAP DUNG DU LIEU");
    console.log(
      countProductA +
        " " +
        countProductB +
        " " +
        countProductC +
        " " +
        countProductD +
        " " +
        priceProduct
    );
    return;
  }

  const imgElement = document.querySelector(".imgPreview");
  let img = imgElement ? imgElement.src : ""; // Null check for imgPreview
  if (img.startsWith(".")) {
    img = img.substring(1);
  }

  // Tìm sản phẩm trong danh sách và cập nhật
  for (let i = 0; i < ArrProduct.length; i++) {
    if (ArrProduct[i].idproduct === id) {
      ArrProduct[i].colorr1 = codecolorProduct;
      ArrProduct[i].quantity.A = countProductA;
      ArrProduct[i].quantity.B = countProductB;
      ArrProduct[i].quantity.C = countProductC;
      ArrProduct[i].quantity.D = countProductD;
      ArrProduct[i].price = priceProduct;
      ArrProduct[i].nameSP = nameProduct;
      ArrProduct[i].img = img;
      ArrProduct[i].nametag = nametagProduct;
      break;
    }
  }
  // Lưu lại vào localStorage
  localStorage.setItem("arrayproducts", JSON.stringify(ArrProduct));

  // Cập nhật giao diện
  closeTabz();
  makeIDproduct();
  renderqlsp();
}
// Hàm ẩn menu
function hideContextMenu() {
  let z = document.getElementById("contextMenu");
  if (z != null) {
    z.style.display = "none";
  }
}

// Ẩn menu khi nhấp chuột ra ngoài
window.addEventListener("click", hideContextMenu);
// ---------------------------------------------------------------------------------
// thong ke

const namee = ["Sweater", "Sơ mi", "Hoodie", "Áo khoác", "Áo thun", "Polo"];

// Hàm tạo biểu đồ
function createChart() {
  const ctx = document.getElementById("grapbox").getContext("2d");
  const chartData = {
    labels: namee,
    datasets: [
      {
        label: "Đã Bán",
        data: [
          Arrsell.filter((i) => i.obj.nametag === "sweater#").reduce(
            (i, n) => i + n.soluong,
            0
          ),
          Arrsell.filter((i) => i.obj.nametag === "somi#").reduce(
            (i, n) => i + n.soluong,
            0
          ),
          Arrsell.filter((i) => i.obj.nametag === "hoodie#").reduce(
            (i, n) => i + n.soluong,
            0
          ),
          Arrsell.filter((i) => i.obj.nametag === "aokhoac#").reduce(
            (i, n) => i + n.soluong,
            0
          ),
          Arrsell.filter((i) => i.obj.nametag === "aothun#").reduce(
            (i, n) => i + n.soluong,
            0
          ),
          Arrsell.filter((i) => i.obj.nametag === "polo#").reduce(
            (i, n) => i + n.soluong,
            0
          ),
        ],
        backgroundColor: [
          "rgb(255, 99, 132)",
          "rgb(75, 192, 192)",
          "rgb(255, 205, 86)",
          "rgb(201, 203, 207)",
          "rgb(54, 162, 235)",
          "rgb(70, 182, 222)",
        ],
      },
    ],
  };
  new Chart(ctx, {
    type: "polarArea",
    data: chartData,
    options: {},
  });
}

//mo menu them san pham
function btnAdd() {
  let backround = document.querySelector(".outbackround");
  let s = document.querySelector(".btnAddproduct");
  s.classList.add("actz");
  s.classList.remove("nonez");
  backround.classList.add("actoutbackground");
  renderBtnadd();
}
//dong menu them san pham
function closeTabb() {
  let backround = document.querySelector(".outbackround");
  let s = document.querySelector(".btnAddproduct");
  s.classList.remove("actz");
  s.classList.add("nonez");
  backround.classList.remove("actoutbackground");
}

//chap nhan
function btnAccept() {
  let ArrProduct = JSON.parse(localStorage.getItem("arrayproducts"));
  const nameAddProduct = document.getElementById("nameAddProduct").value.trim();
  const colorAddProduct = document
    .getElementById("colorAddProduct")
    .value.trim();
  // const codecolorAddProduct = document.getElementById("colorAddProduct").value.trim();
  const countAddProductA = parseInt(
    document.getElementById("countAddProductA").value.trim()
  );
  const countAddProductB = parseInt(
    document.getElementById("countAddProductB").value.trim()
  );
  const countAddProductC = parseInt(
    document.getElementById("countAddProductC").value.trim()
  );
  const countAddProductD = parseInt(
    document.getElementById("countAddProductD").value.trim()
  );
  const priceAddProduct = parseFloat(
    document.getElementById("priceAddProduct").value.trim()
  );
  const nametagProduct = document.getElementById("typeproduct_").value.trim();

  // Validation dữ liệu
  if (
    !validateInputs(
      nameAddProduct,
      colorAddProduct,
      priceAddProduct,
      countAddProductA,
      countAddProductB,
      countAddProductC,
      countAddProductD
    )
  ) {
    alert("Vui lòng nhập đầy đủ và đúng dữ liệu.");
    return;
  }
  // Tạo sản phẩm mới
  const id = `${nametagProduct}${countProduct(ArrProduct) + 1}`;
  const imgElement = document.querySelector(".imgPreview");
  const img = imgElement ? imgElement.src : ""; // Null check cho imgPreview

  // Hiển thị xác nhận
  toggleConfirmationDialog(true);

  // Gắn sự kiện xác nhận
  document.getElementById("yes").onclick = () => {
    const newProduct = createProduct({
      idproduct: id,
      nameSP: nameAddProduct,
      img: img,
      price: priceAddProduct,
      quantity: {
        A: countAddProductA,
        B: countAddProductB,
        C: countAddProductC,
        D: countAddProductD,
      },
      nametag: nametagProduct,
      nameColor1: colorAddProduct,
      colorr1: colorAddProduct,
    });

    // Cập nhật danh sách sản phẩm
    ArrProduct.push(newProduct);
    localStorage.setItem("arrayproducts", JSON.stringify(ArrProduct));
    renderqlsp();
    renderBtnadd();
    toggleConfirmationDialog(false);
    closeTabb();
  };

  document.getElementById("no").onclick = () => {
    toggleConfirmationDialog(false);
    closeTabb();
  };
}

function validateInputs(name, color, price, ...counts) {
  if (
    !name ||
    !color ||
    isNaN(price) ||
    counts.some((count) => count === "" || isNaN(count))
  ) {
    return false;
  }
  return true;
}

function toggleConfirmationDialog(show) {
  const confirmationDialog = document.querySelector(".sb");
  if (show) {
    confirmationDialog.classList.add("actsb");
    confirmationDialog.classList.remove("nonesb");
  } else {
    confirmationDialog.classList.remove("actsb");
    confirmationDialog.classList.add("nonesb");
  }
}

function createProduct({
  idproduct,
  nameSP,
  img,
  price,
  quantity,
  nametag,
  nameColor1,
  colorr1,
}) {
  return {
    idproduct: idproduct,
    nameSP: nameSP,
    img: img,
    price: price,
    quantity: quantity,
    nametag: nametag,
    nameColor1: nameColor1,
    colorr1: colorr1,
  };
}
// tai anh len
function onloandimg(input) {
  const imageContainer = document.getElementById("imageContainer");
  const file = input.files[0]; // Lấy tệp đầu tiên

  if (file) {
    const reader = new FileReader();

    reader.onload = function (e) {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.classList.add("imgPreview");
      imageContainer.innerHTML = "";
      imageContainer.appendChild(img);
    };
    // Đọc file dưới dạng Data URL
    reader.readAsDataURL(file);
  }
}

function listSearch_tk() {
  let arr = [...Arrsell];
  let typeProduct = document.getElementById("typeProduct").value;
  if (typeProduct !== "0") {
    arr = Arrsell.filter((i) => i.obj.nametag === typeProduct);
  }
  rankProfit(arr);
}
function renderqltk() {
  const selectedTime = document.getElementById("op-time")?.value || []; // Mặc định chọn ngày hôm nay nếu chưa chọn
  document.querySelector(".page-right").innerHTML = `<div class = qltk>
  <h1>SỐ LIỆU THỐNG KÊ</h1>
  <div class="overview">
      <div class="chart ff"><canvas style="display: block; box-sizing: border-box;" id="grapbox" width="541px" height="541px"></canvas></div>
      <div class="ll">
         <div class="boder first">
          <h1>Thống kê</h1>
          <div class="select-time">
           <input onchange="chon_time_sp()" type="date" id="op-time" value="${selectedTime}"></input>
          </div>
         </div> 
         <div class="boder">
              <div class="left-boder">
                  <h2 style="color: blue;">${Arrsell.reduce(
                    (i, n) => i + n.soluong,
                    0
                  )}</h2>
                  <h2 style="font-weight: 200;">ĐÃ BÁN</h2> 
              </div>
              <div class="right-boder"><i style="font-size: 40px;font-weight: 200;" class='bx bx-cart-alt'></i></div>   
         </div> 
         <div class="boder">
              <div class="left-boder">
                  <h2 style="color: blue;">${Arrsell.reduce(
                    (i, n) => i + n.soluong * n.obj.price,
                    0
                  ).toLocaleString("vi-VN", {
                    style: "currency",
                    currency: "VND",
                  })}</h2>
                  <h2 style="font-weight: 200;">DOANH THU</h2>
              </div>
              <div class="right-boder"><i style="font-size: 40px;font-weight: 200;" class='bx bx-money-withdraw'></i></div>   
         </div> 
         <div class="boder __m">
            <div class="m">
              <span style="width: 10%">ID</span>
              <span style="width: 50%">Tên</span>
              <span style="width: 40%">Số Tiền</span>
            </div>
            <div class="boder_KH"></div>        
         </div>
      </div>
   </div>
</div>
<div class="part">
  <div style="width: 70%" class="rankProfit">
      <div style="margin-top: 0px; position:unset; " class="titleCol">
            <span style="width: 30%;" class="name">TÊN SẢN PHẨM</span>
            <span style="width: 30%;" class="sold">Đã bán</span>
            <span style="width: 10%; float: right" class="profits">DOANH THU</span>
      </div>
      <div id="rankProfit-body"></div>
  </div>
  <div style="width: 30%" onchange="listSearch_tk()" class="data-number">
              <select name="" id="typeProduct" class="box">
                    <option value="0">Tất cả</option>
                    <option value="aothun#">Áo thun</option>
                    <option value="polo#">Polo</option>
                    <option value="somi#">Sơ mi</option>
                    <option value="hoodie#">Hoodie</option>
                    <option value="sweater#">Sweater</option>
                    <option value="aokhoac#">Áo khoác</option>
              </select>
    </div>
</div>`;
  createChart();
  rankProfit(Arrsell);
}

// tinh ngay
function getDaysDifference(dateString) {
  // Chuyển chuỗi ngày "yyyy-mm-dd" thành đối tượng Date
  const inputDate = new Date(dateString);
  const currentDate = new Date();
  currentDate.setHours(0, 0, 0, 0);
  const diffMilliseconds = currentDate - inputDate;
  return Math.floor(diffMilliseconds / (1000 * 60 * 60 * 24)); // Làm tròn xuống
}

function chon_time_sp() {
  Arrsells();
  let time = document.getElementById("op-time").value;
  Arrsell = Arrsell.filter(
    (i) => getDaysDifference(i.time) === getDaysDifference(time)
  );
  let sell = JSON.parse(localStorage.getItem("shopbagispay")) || [];
  sell = sell.filter(
    (i) =>
      i.shopbagispayuser?.[0]?.status === "4" &&
      getDaysDifference(i.shopbagispayuser[0]?.time) === getDaysDifference(time)
  );
  localStorage.setItem("filteredSell", JSON.stringify(sell)); // day len de listKH lay duoc
  renderqltk(); //cap nhat
  renderlistKH();
}

function Arrsells() {
  Arrsell = [];
  let sell = JSON.parse(localStorage.getItem("shopbagispay")) || [];
  let Arrll = sell.flatMap((i) => i.shopbagispayuser);
  for (let i = 0; i < Arrll.length; i++) {
    if (Arrll[i].status === "4") {
      Arrsell.push(Arrll[i]);
    }
  }
}

function nameuser(id) {
  let namez = JSON.parse(localStorage.getItem("storageUsers"));
  let nameID = "";
  namez.forEach((i) => {
    if (i.userID === id) {
      nameID = i.name;
    }
  });
  return nameID;
}

function renderlistKH() {
  let sell = JSON.parse(localStorage.getItem("filteredSell")) || []; // Lấy danh sách đã lọc
  let s = "";
  const sortsell = sell
    .filter((i) => i.shopbagispayuser?.[0]?.status === "4")
    .sort((a, b) => {
      const aQuantity = a.shopbagispayuser[0]?.soluong || 0;
      const aPrice = a.shopbagispayuser[0]?.obj?.price || 0;
      const bQuantity = b.shopbagispayuser[0]?.soluong || 0;
      const bPrice = b.shopbagispayuser[0]?.obj?.price || 0;
      return bQuantity * bPrice - aQuantity * aPrice;
    });
  sortsell.forEach((i) => {
    const quantity = i.shopbagispayuser[0]?.soluong || 0;
    const price = i.shopbagispayuser[0]?.obj?.price || 0;
    const priceVnd = (quantity * price).toLocaleString("vi-VN", {
      style: "currency",
      currency: "VND",
    });
    s += `
      <div class="list__KH">
        <span style="width: 10%" class="ID_KH">${i.IDuser}</span>
        <span style="width: 50%" class="name_KH">${nameuser(i.IDuser)}</span>
        <span style="width: 40%" class="price_KH">${priceVnd}</span>
      </div>
    `;
  });
  document.querySelector(".boder_KH").innerHTML = s;
}

function processProductList(Arrsell) {
  let map = new Map();
  for (let i of Arrsell) {
    let key = i.obj.idproduct + i.obj.nameSP;
    if (map.has(key)) {
      // Nếu sản phẩm đã tồn tại, cộng dồn số lượng
      map.get(key).soluong += i.soluong;
    } else {
      // Nếu chưa tồn tại, thêm sản phẩm vào Map
      map.set(key, { ...i });
    }
  }
  let resultArr = Array.from(map.values());
  return resultArr;
}

//ham tao doanh thu
function rankProfit(arrs) {
  let arr = processProductList(arrs);
  let s = "";
  const sortArrsell = arr.sort(
    (a, b) => b.soluong * b.obj.price - a.soluong * a.obj.price
  );
  sortArrsell.forEach((i) => {
    s += ` <div class="rankProfit-Child">
            <span style="width: 30%;" class="name">${i.obj.nameSP}</span>
            <span style="width: 30%;" class="sold">${i.soluong}</span>
            <span style="width: 10%;  class="profits">${(
              i.obj.price * i.soluong
            ).toLocaleString("vi-VN", {
              style: "currency",
              currency: "VND",
            })}</span>
           </div>`;
  });
  document.getElementById("rankProfit-body").innerHTML = s;
}

function renderBtnadd() {
  document.querySelector(".btnAddproduct").innerHTML = `<div id="tabAddProduct">
                <div class="headTab">
                    <span class="title">THÊM SẢN PHẨM</span>
                    <span onclick ="closeTabb()" class="closeTab">ĐÓNG</span>
                </div>
                <form action="">
                  <div class="bodyTab">
                      <div class="leftTab">
                          <div class="contentTab">
                              <span>STT: </span>
                              <span>${countProduct(ArrProduct) + 1}</span>
                          </div>
                          <div class="contentTab">
                              <div id="imageContainer"></div>
                              <input type="file" name="file" id="file" class="inputfile" accept="image/*" onchange="onloandimg(this)">
                              <label style="margin-left:-75px;" for="file">Chọn ảnh</label>
                          </div>
                              <div class="contentTab"> 
                                  <span>Tên sản phẩm: </span>
                                  <input style="width: 50%" type="text" placeholder="Tên sản phẩm" value="" id="nameAddProduct">
                              </div>
                              <div class="contentTab colorInput">
                                  <span>Màu sắc: </span>
                                <select id="colorAddProduct">
                                  <option value="white">white</option>
                                  <option value="red">red</option>
                                  <option value="blue">blue</option>
                                  <option value="green">green</option>
                                  <option value="yellow">yellow</option>
                                  <option value="orange">orange</option>
                                  <option value="pink">pink</option>
                                  <option value="purple">purple</option>
                                </select>
                              </div>
                              <div class="contentTab">
                                  <span>Số lượng A: </span>
                                  <input style="width: 20%" type="text" id="countAddProductA" placeholder="Số lượng" value="">
                              </div>
                      </div>
                      <div class="rightTab">
                                  <div class="contentTab">
                                      <span>Số lượng B: </span>
                                      <input style="width: 20%" type="text" id="countAddProductB" placeholder="Số lượng" value="">
                                  </div>
                                  <div class="contentTab">
                                      <span>Số lượng C: </span>
                                      <input style="width: 20%" type="text" id="countAddProductC" placeholder="Số lượng" value="">
                                  </div>
                                  <div class="contentTab">
                                      <span>Số lượng D: </span>
                                      <input style="width: 20%" type="text" id="countAddProductD" placeholder="Số lượng" value="">
                                  </div>
                                  <div class="contentTab">
                                      <span>Đơn giá: </span>
                                      <input style="width: 30%" type="text" id="priceAddProduct" placeholder="Đơn giá" value="">
                                  </div>
                                  <div class="contentTab">
                                    <span>Loai : </span>
                                    <select id="typeproduct_">
                            
                                    </select>
                                  </div>
                                  
                      </div>
                  </div>  
                  <div onclick="btnAccept()" class="btnAccept">
                      <div class="content-btn">
                          <buttom type="sumbit">HOÀN TẤT</buttom>
                      </div>
                  </div>
                </form>
            </div>`;
  tao_option_type_add();
}

function tao_option_type_add() {
  let typeproduct = JSON.parse(localStorage.getItem("typeproduct"));
  let s = "";
  typeproduct.forEach((i) => {
    s += `<option value=${i.typeid}>${i.typename}</option>`;
  });
  document.querySelector("#typeproduct_").innerHTML = s;
}

//dong tap cua view
function closeTabz() {
  document.querySelector(".outbackround").classList.remove("actoutbackground");
  document.querySelector(".viewmenu").classList.remove("actz");
  document.querySelector(".viewmenu").classList.add("nonez");
}
// -------------------------------------------------------------------
function savepage(n) {
  localStorage.setItem("currentadmin", n);
}

function onload() {
  const QLTK = document.querySelector(".b1");
  const QLDH = document.querySelector(".b2");
  const QLSP = document.querySelector(".b3");
  const QLND = document.querySelector(".b4");
  const user = document.querySelector(".page-left .L-u ._icon_user");

  const s = parseInt(localStorage.getItem("currentadmin")) || 1;

  QLTK.addEventListener("click", () => {
    QLTK.classList.add("act");
    QLDH.classList.remove("act");
    QLSP.classList.remove("act");
    QLND.classList.remove("act");
    user.style.color = "white";
    savepage(1);
    renderqltk();
  });

  QLDH.addEventListener("click", () => {
    QLTK.classList.remove("act");
    QLDH.classList.add("act");
    QLSP.classList.remove("act");
    QLND.classList.remove("act");
    user.style.color = "white";
    savepage(2);
    renderqldh();
  });

  QLSP.addEventListener("click", () => {
    QLTK.classList.remove("act");
    QLDH.classList.remove("act");
    QLSP.classList.add("act");
    QLND.classList.remove("act");
    user.style.color = "white";
    let getButton1ContextMenu = document.getElementById(
      "button1-contextMenu"
    ).nextSibling;
    getButton1ContextMenu.nodeValue = "Chỉnh sửa";
    document.getElementById("deleteProduct").style.display = "block";
    savepage(3);
    renderqlsp();
  });

  QLND.addEventListener("click", () => {
    QLTK.classList.remove("act");
    QLDH.classList.remove("act");
    QLSP.classList.remove("act");
    QLND.classList.add("act");
    user.style.color = "white";
    savepage(4);
    renderqlnd();
  });

  user.addEventListener("click", () => {
    QLTK.classList.remove("act");
    QLDH.classList.remove("act");
    QLSP.classList.remove("act");
    QLND.classList.remove("act");
    user.style.color = "blue";
  });

  // Thiết lập trạng thái ban đầu
  switch (s) {
    case 1:
      QLTK.classList.add("act");
      renderqltk();
      break;
    case 2:
      QLDH.classList.add("act");
      renderqldh();
      break;
    case 3:
      QLSP.classList.add("act");
      renderqlsp();
      break;
    case 4:
      QLND.classList.add("act");
      renderqlnd();
      break;
  }
}
// -----------------------------------------------

// user admin
function user_click() {
  console.log("user admin");
  document.querySelector(".page-right").innerHTML = `heki`;
}

// -----------------------------------------
//thuy
// tao danh sach nguoi dung
function closeall() {
  document.querySelector(".block-container").classList.remove("active");
  document.querySelector(".backgroud-menu-respon").style.display = "none";
}
function listAccounts() {
  let accounts = JSON.parse(localStorage.getItem("storageUsers")) || [];
  let s = "";
  accounts.forEach((account) => {
    const classPrefix = `user-${account.userID}`; // Tạo tiền tố lớp hợp lệ
    s += `<div class="listAcc" style="text-align: center; border-bottom: 1px solid rgba(112, 112, 112, 0.3);">
        <span class="idAccount" style="width: 5%;">${account.userID}</span>
        <span class="nameAccount" style="width: 15%;">${account.name}</span>
        <span class="phoneAccount" style="width: 10%;">${account.phone}</span>
        <span class="emailAccount" style="width: 16%;">${account.email}</span>
        <span class="addressAccount" style="width: 17%;">${
          account.diachi
        }</span>
        <span class="passwordAccount" style="width: 12%;">${
          account.password
        }</span>
        <span class="statusAccount" style="width: 10%;">${
          account.statususer == "1" ? "Bình thường" : "Đã khoá"
        }</span>
        <button class="btnAccount" style="width: 10%;" onclick="toggleLockUser('${
          account.userID
        }')">${account.statususer == "0" ? "Mở khóa" : "Khóa"}</button>
        <button class="change" style="width: 5%;" onclick='changeuserinfo(${JSON.stringify(
          account
        )})'>Sửa</button>
      </div>`;
  });
  return s;
}

let isEditingaccountuser = false;
function innertooladdress(account) {
  document.querySelector(".block-container").innerHTML = `
      <div class="form-group-userID">
        <label for="userID">UserID: </label>
        <span>${account.userID}</span>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="Nhập email" value="${
          account.email
        }"/>
      </div>
      <div class="form-group">
        <label for="sdt">Số điện thoại</label>
        <input
          type="text"
          id="sdt"
          name="sdt"
          placeholder="Nhập số điện thoại"
          value="${account.phone}"
        />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input
          type="text"
          id="password"
          name="password"
          placeholder="Nhập password"
          value="${account.password}"
        />
      </div>
      <div class="form-group">
        <label for="name">Tên</label>
        <input type="text" id="name" name="name" placeholder="Nhập tên" value="${
          account.name
        }" />
      </div>
      <div class="form-group">
        <div style="display:flex;align-items:center">
          <label for="name">Địa chỉ</label>
          <span class="spanaddress add_address" onclick='hienthiformaddaddress(${JSON.stringify(
            account
          )})'>Thêm</span>
          <span class="spanaddress remove_address" onclick='hienthiformremoveaddress(${JSON.stringify(
            account
          )})'>Xoá</span>
        </div>
        <select id="diachi" name="diachi">
        </select>
      </div>
      <div class="form-actions">
            <div class="confirm-button" onclick='agreechangeuser(${JSON.stringify(
              account
            )})'>Xác nhận</div>
        </div>`;
  makeAddressSelect(account);
}
function makeAddressSelect(account) {
  let addressUsers =
    JSON.parse(localStorage.getItem("addressUserCurrent")) || [];
  let user = JSON.parse(localStorage.getItem("currentUser"));
  let index = kiemtratontaiuser(account.userID);
  let s = "";
  if (index != null) {
    for (let i = 0; i < addressUsers[index].address.length; i++) {
      s += `<option value="${i}">${addressUsers[index].address[i]}</option>`;
    }
  }
  document.querySelector("#diachi").innerHTML = s;
}
function hienthiformremoveaddress(account) {
  let addressUsers =
    JSON.parse(localStorage.getItem("addressUserCurrent")) || [];
  let index = kiemtratontaiuser(account.userID);
  let choice = document.querySelector("#diachi").value;
  console.log(index);
  // Truyền đối tượng với hai tham số: account và choice
  if (addressUsers[index].address.length == 0) {
    toast({
      title: "ERROR",
      message: "Không có địa chỉ nào để xoá!",
      type: "error",
      duration: 5000,
    });
  } else {
    document.querySelector(".block-container").innerHTML = `
   <div class="remove">
    <div>${addressUsers[index].address[choice]}</div>
    <h3 class="confirmation-text">Bạn thật sự muốn xoá địa chỉ này?</h3>
    <div class="action-buttons">
      <div class="action-button yes" onclick='removeaddress(${JSON.stringify({
        account: account,
        choice: choice,
      })})'>Yes</div>
      <div class="action-button no" onclick='innertooladdress(${JSON.stringify(
        account
      )})'>No</div>
    </div>
  </div>
  <div class="back" onclick='innertooladdress(${JSON.stringify(
    account
  )})'>Trở lại</div>`;
  }
}

function removeaddress(data) {
  let account = data.account; // Lấy account
  let choice = data.choice; // Lấy choice
  let addressUsers =
    JSON.parse(localStorage.getItem("addressUserCurrent")) || [];
  let index = kiemtratontaiuser(account.userID);
  addressUsers[index].address.splice(choice, 1);
  localStorage.setItem("addressUserCurrent", JSON.stringify(addressUsers));
  toast({
    title: "SUCCESS",
    message: "Xoá địa chỉ thành công !",
    type: "success",
    duration: 5000,
  });
  innertooladdress(account);
}
function hienthiformaddaddress(account) {
  let addressUsers =
    JSON.parse(localStorage.getItem("addressUserCurrent")) || [];
  let index = kiemtratontaiuser(account.userID);
  let choice = document.querySelector("#diachi").value;
  document.querySelector(".block-container").innerHTML = `
      <div style="text-align:center">Thêm địa chỉ mới</div>
      <div class="form-group-userID">
        <label for="userID">UserID: </label>
        <span>${account.name}</span>
      </div>
      <div class="form-group">
        <label for="email">Nhập số nhà & tên đường</label>
        <input
          type="text"
          id="numberaddress"
          placeholder="Nhập số nhà & tên đường"
        />
      </div>
      <div class="form-group">
        <label for="city">Thành phố:</label>
        <select id="city" onchange="populateDistricts()">
          <option value="">Chọn Thành phố</option>
        </select>
      </div>
      <div class="form-group">
        <label for="district">Quận/Huyện:</label>
        <select id="district" onchange="populateWards()">
          <option value="">Chọn Quận/Huyện</option>
        </select>
      </div>
      <div class="form-group">
        <label for="ward">Phường/Xã:</label>
        <select id="ward">
          <option value="">Chọn Phường/Xã</option></select
        >
      </div>
      <div class="form-actions">
          <div class="confirm-button" onclick='addaddress(${JSON.stringify(
            account
          )})'>Xác nhận</div>
      </div>
      <div class="back" onclick='innertooladdress(${JSON.stringify(
        account
      )})'>Trở lại</div>`;
  populateCities();
}
function isValidPhoneNumber(phoneNumber) {
  // Kiểm tra số điện thoại có đúng định dạng hay không (ví dụ: phải là chuỗi 10-11 chữ số)
  const phoneRegex = /^[0-9]{10,11}$/; // Điều kiện: chỉ chứa chữ số và có độ dài 10-11 ký tự
  return phoneRegex.test(phoneNumber);
}

function isValidHouseNumber(houseNumber) {
  // Biểu thức chính quy kiểm tra số nhà.
  // Ví dụ: cho phép số nhà là một chuỗi bắt đầu bằng số, có thể có dấu cách hoặc ký tự sau.
  const regex = /^[0-9]+[a-zA-Z0-9\s]*$/;
  return regex.test(houseNumber);
}
function updateUserDetails(user) {
  let allUsers = JSON.parse(localStorage.getItem("storageUsers")) || [];
  for (let i = 0; i < allUsers.length; i++) {
    if (allUsers[i].userID == user.userID) {
      allUsers[i] = user;
    }
  }
  localStorage.setItem("storageUsers", JSON.stringify(allUsers));
}
function addaddress(account) {
  let addressUsers =
    JSON.parse(localStorage.getItem("addressUserCurrent")) || [];
  let index = kiemtratontaiuser(account.userID);
  let sonha = document.querySelector("#numberaddress").value;
  let quan = document.querySelector("#district").value;
  let phuong = document.querySelector("#ward").value;
  let city = document.querySelector("#city").value;
  let s = `${sonha},${phuong},${quan},${city}`;
  console.log(s);
  console.log(addressUsers[index].address);
  if (isValidHouseNumber(sonha)) {
    addressUsers[index].address.push(s);
    localStorage.setItem("addressUserCurrent", JSON.stringify(addressUsers));
    toast({
      title: "SUCCESS",
      message: "Thêm địa chỉ thành công",
      type: "success",
      duration: 5000,
    });
  } else {
    toast({
      title: "ERROR",
      message:
        "Số nhà không hợp lệ.Chỉ chứa chữ số và có thể có ký tự chữ cái hoặc số phía sau",
      type: "error",
      duration: 5000,
    });
  }
  innertooladdress(account);
}
function changeuserinfo(account) {
  innertooladdress(account);
  document.querySelector(".block-container").classList.add("active");
  document.querySelector(".backgroud-menu-respon").style.display = "block";
}
function kiemtratontaiuser(userid) {
  let addressUserCurrent = JSON.parse(
    localStorage.getItem("addressUserCurrent")
  );
  for (let i = 0; i < addressUserCurrent.length; i++) {
    if (addressUserCurrent[i].IDuser == userid) {
      return i;
    }
  }
  return null;
}
function agreechangeuser(account) {
  let name = document.querySelector("#name").value;
  let email = document.querySelector("#email").value;
  let phone = document.querySelector("#sdt").value;
  let password = document.querySelector("#password").value;
  if (isValidEmail(email) == false) {
    toast({
      title: "ERROR",
      message: "Vui lòng kiểm tra định dạng email",
      type: "error",
      duration: 5000,
    });
    return;
  }
  if (isValidPhoneNumber(phone) == false) {
    toast({
      title: "ERROR",
      message: "Vui lòng kiểm tra định dạng số điện thoại",
      type: "error",
      duration: 5000,
    });
    return;
  }
  account.name = name;
  account.password = password;
  account.phone = phone;
  account.email = email;
  updateUserDetails(account);
  closeall();
}
function timkiemTheoID(id) {
  let accounts = JSON.parse(localStorage.getItem("storageUsers")) || [];
  for (let i = 0; i < accounts.length; i++) {
    if (accounts[i].userID == id) {
      return i;
    }
  }
  return null;
}
function toggleLockUser(idAccount) {
  let accounts = JSON.parse(localStorage.getItem("storageUsers")) || [];
  let index = timkiemTheoID(idAccount);
  if (accounts[index]) {
    if (accounts[index].statususer == "1") {
      accounts[index].statususer = "0";
    } else {
      accounts[index].statususer = "1";
    }
    localStorage.setItem("storageUsers", JSON.stringify(accounts));
    checkAccount();
  }
}
// kiem tra tai khoan
function checkAccount() {
  let accounts = JSON.parse(localStorage.getItem("storageUsers")) || [];
  let locked = 0;
  for (let acc of accounts) {
    if (acc.statususer == "0") {
      locked++;
    }
  }
  document.getElementById("amountOfAccount").innerHTML = accounts.length;
  document.getElementById("amountLockedAccount").innerHTML = locked;
  document.getElementById("amountUnlockedAccount").innerHTML =
    accounts.length - locked;
  document.getElementById("manageCustomer-body").innerHTML = listAccounts();
}

function hienthiformadduser() {
  console.log("abc");
  document.querySelector(
    ".block-container"
  ).innerHTML = `<div class="form-group">
        <label for="sdt">Số điện thoại</label>
        <input
          type="text"
          id="sdt"
          name="sdt"
          placeholder="Nhập số điện thoại"
          value=""
        />
      </div>
      <!-- Tên -->
      <div class="form-group">
        <label for="name">Tên</label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="Nhập tên"
          value=""
        />
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input
          type="text"
          id="email"
          name="email"
          placeholder="Nhập Email"
          value=""
        />
      </div>
      <div class="form-group">
        <label for="passowrd">Password</label>
        <input
          type="password"
          id="password"
          name="password"
          placeholder="Nhập password"
          value=""
        />
      </div>
      <div class="form-actions">
          <div class="confirm-button" onclick="addUser()">Xác nhận</div>
      </div>`;
  document.querySelector(".block-container").classList.add("active");
  document.querySelector(".backgroud-menu-respon").style.display = "block";
}

function addUser() {
  let arrUser = JSON.parse(localStorage.getItem("storageUsers")) || [];
  let idUser = JSON.parse(localStorage.getItem("NextID")) || 0;
  let name = document.querySelector("#name").value;
  let phone = document.querySelector("#sdt").value;
  let email = document.querySelector("#email").value;
  let password = document.querySelector("#password").value;
  let user = {
    userID: "",
    name: "",
    email: "",
    phone: "",
    diachi: "",
    shopbag: "",
    statususer: "1",
    password: "",
    typeuser: "1",
  };
  if (isValidPhoneNumber(phone) == false) {
    toast({
      title: "ERROR",
      message: "Vui lòng kiểm tra định dạng số điện thoại",
      type: "error",
      duration: 5000,
    });
    return;
  }
  if (isValidEmail(email) == false) {
    toast({
      title: "ERROR",
      message: "Vui lòng kiểm tra định dạng email",
      type: "error",
      duration: 5000,
    });
    return;
  }
  user.userID = idUser + 1;
  user.name = name;
  user.phone = phone;
  user.email = email;
  user.password = password;
  arrUser.push(user);
  localStorage.setItem("NextID", JSON.stringify(idUser + 1));
  localStorage.setItem("storageUsers", JSON.stringify(arrUser));
  renderqlnd();
}

function renderqlnd() {
  document.querySelector(".page-right").innerHTML = `
              <div class="backgroud-menu-respon" onclick="closeall()"></div>
              <div class="tool-address"></div>
              <div class="block-container"></div>
              <div class="qlnd">
                <div class="title">
                    <h1>QUẢN LÝ NGƯỜI DÙNG</h1>
                </div>
                 <div class="btnAdd" onclick="hienthiformadduser()"><div class="circle"><i class="fa-solid fa-plus"></i></div></div>
                <div class="manageCustomer">
                    <div class="areNumberAboutAccounts">
                        <div class="box">
                            <div class="contentBox">
                                <div class="leftContent">
                                    <h2 id="amountOfAccount">0</h2>
                                    <span>TÀI KHOẢN</span>
                                </div>
                                <div class="rightContent">
                                    <i class='bx bxs-user-account'></i>
                                </div>
                            </div>
                        </div>
                        <div class="box">
                            <div class="contentBox">
                                <div class="leftContent">
                                    <h2 id="amountUnlockedAccount">0</h2>
                                    <span>TK HOẠT ĐỘNG</span>
                                </div>
                                <div class="rightContent">
                                    <i class='bx bxs-lock-open'></i>
                                </div>
                            </div>
                        </div>
                        <div class="box">
                            <div class="contentBox">
                                <div class="leftContent">
                                    <h2 id="amountLockedAccount">0</h2>
                                    <span>TK BỊ KHÓA</span>
                                </div>
                                <div class="rightContent">
                                    <i class='bx bx-key'></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="titleCol" style="text-align: center;">
                        <span class="idAccount" style="width: 5%;">ID</span>
                        <span class="nameAccount" style="width: 15%;">Tên</span>
                        <span class="phoneAccount" style="width: 10%;">SĐT</span>
                        <span class="emailAccount" style="width: 16%;">Email</span>
                        <span class="usernameAccoutn" style="width: 17%;">Địa chỉ</span>
                        <span class="passwordAccount" style="width: 12%;">Mật khẩu</span>
                        <span class="statusAccount" style="width: 10%;">Trạng thái</span>
                        <span class="Chitiet" style="width: 10%;">Chi tiết</span>
                        <span style="width:5%;"></span>
                    </div>
                    <div id="manageCustomer-body">
                        
                    </div>
                </div>
            </div>`;
  checkAccount();
}
// vinh render qldh
let getShopBag = JSON.parse(localStorage.getItem("shopbagispay")) || [];

function showDetailInformation(event, element) {
  event.preventDefault();
  // Lấy vị trí chuột
  const posX = event.pageX;
  const posY = event.pageY;
  // Hiển thị menu ở vị trí chuột
  contextMenu.style.display = "block";
  contextMenu.style.left = `${posX}px`;
  contextMenu.style.top = `${posY}px`;

  let idProduct = element.querySelector(".idProduct").textContent;
  let userID = element.querySelector(".userID").textContent;
  let parseUserIDToInt = parseInt(userID);
  let order;
  let flag = false;
  for (let i = 0; i < getShopBag.length; i++) {
    if (flag) break;
    if (parseUserIDToInt !== getShopBag[i].IDuser) continue;
    for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
      if (idProduct === getShopBag[i].shopbagispayuser[j].obj.idproduct) {
        order = {
          IDuser: getShopBag[i].IDuser,
          diachi: getShopBag[i].shopbagispayuser[j].diachi,
          shopbagispayuser: [getShopBag[i].shopbagispayuser[j]],
          time: getShopBag[i].shopbagispayuser[j].time,
          paymenttype: getShopBag[i].shopbagispayuser[j].paymenttype,
          size: getShopBag[i].shopbagispayuser[j].size,
        };
        flag = true;
        break;
      }
    }
  }
  let imgProduct = order.shopbagispayuser[0].obj.img;
  let nameProduct = order.shopbagispayuser[0].obj.nameSP;
  let colorProduct = order.shopbagispayuser[0].color;
  let price = element.querySelector(".priceProduct").textContent;
  let nametagProduct = order.shopbagispayuser[0].obj.nametag;
  let quantity = order.shopbagispayuser[0].soluong;
  let typeProduct = "";
  let nameOfCustomer = "";
  let timeOfOrder = order.time;
  let addressOfCustomer = order.diachi;
  let getStorageUsers = JSON.parse(localStorage.getItem("storageUsers"));
  let getSize = order.size;
  let typeOfPayment = "";
  if (order.paymenttype === 0) {
    typeOfPayment = "Nhận hàng";
  } else if (order.paymenttype === 1) {
    typeOfPayment = "Chuyển khoản";
  }
  for (let i = 0; i < getStorageUsers.length; i++) {
    if (parseInt(userID) === getStorageUsers[i].userID) {
      nameOfCustomer = getStorageUsers[i].name;
      break;
    }
  }
  switch (true) {
    case nametagProduct.startsWith("hoodie#"):
      typeProduct = "Hoodie";
      break;
    case nametagProduct.startsWith("sweater#"):
      typeProduct = "Sweater";
      break;
    case nametagProduct.startsWith("somi#"):
      typeProduct = "Sơ mi";
      break;
    case nametagProduct.startsWith("polo#"):
      typeProduct = "Polo";
      break;
    case nametagProduct.startsWith("aothun#"):
      typeProduct = "Áo thun";
      break;
    default:
      typeProduct = "Không xác định";
  }

  // Chi tiết đơn hàng
  // Lấy phần tử chứa "Chỉnh sửa"
  let getButton1ContextMenu = document.getElementById(
    "button1-contextMenu"
  ).nextSibling;
  // Thay đổi "Chỉnh sửa" thành "Chi tiết"
  getButton1ContextMenu.nodeValue = "Chi tiết";
  // Ẩn button deleteProduct khi chạy đoạn mã này
  document.getElementById("deleteProduct").style.display = "none";

  document.getElementById("viewDetails").addEventListener("click", () => {
    document.querySelector(".outbackround").classList.add("actoutbackground");
    document.querySelector(".viewmenu").classList.add("actz");
    document.querySelector(".viewmenu").classList.remove("nonez");

    document.querySelector(".viewmenu").innerHTML = `<div id="tabAddProduct">
      <div class="headTab">
          <span class="title">THÔNG TIN CHI TIẾT</span>
          <span onclick ="closeTabz()" class="closeTab">ĐÓNG</span>
      </div>
      <form action="">
        <div class="bodyTab">
          <div class="leftTab">
            <div class="contentTab">
              <span>ID: </span>
              <span class="ID">${idProduct}</span>
            </div>
            <div class="contentTab">
              <div id="imageContainer"> 
                <img src="${imgProduct}" class="imgPreview">
              </div>
            </div>
            <div class="contentTab"> 
              <span>Tên sản phẩm: </span>
              <input readonly style="width: 50%" type="text" value="${nameProduct}" id="nameAddProduct">
            </div>
            <div class="contentTab">
              <span>Loại: </span>
              <input readonly type="text" value="${typeProduct}" id="typeAddProduct">
            </div>
            <div class="contentTab colorInput">
              <span>Màu sắc: </span>
              <input readonly style="width: 25%" type="text" value="${colorProduct}" id="colorAddProduct">
            </div>
            <div class="contentTab">
              <span>Số lượng mua: </span>
              <input readonly style="width: 20%" type="text" id="countAddProductA" value="${quantity}">
            </div>
            <div class="contentTab">
              <span>Đơn giá: </span>
              <input readonly style="width: 30%" type="text" id="priceAddProduct" value="${price}">
            </div>
          </div>
          <div class="rightTab">
            <div class="contentTab">
              <span>Size: </span>
              <input readonly style="width: 20%" type="text" id="sizeOfProduct" value="${getSize}">
            </div>
            <div class="contentTab">
              <span>Tên khách hàng: </span>
              <input readonly style="width: 20%" type="text" id="nameOfCustomer" value="${nameOfCustomer}">
            </div>
            <div class="contentTab">
              <span>Địa chỉ khách hàng: </span>
              <input readonly style="width: 20%" type="text" id="addressOfCustomer" value="${addressOfCustomer}">
            </div>
            <div class="contentTab">
              <span>Thời gian mua: </span>
              <input readonly type="text" value="${timeOfOrder}" id="timeOfOrder">
            </div>
            <div class="contentTab">
              <span>Loại thanh toán: </span>
              <input readonly style="width: 28%" type="text" id="typeOfPayment" value="${typeOfPayment}">
            </div>
          </div>
        </div>
      </form>
  </div>`;
  });
}
// in đơn hàng
function listDH(ordersOfUser) {
  let s = "";
  for (let i = 0; i < ordersOfUser.shopbagispayuser.length; i++) {
    let Price = ordersOfUser.shopbagispayuser[i].obj.price.toLocaleString(
      "vi-VN",
      { style: "currency", currency: "VND" }
    );
    let stringStatus = "";
    if (ordersOfUser.shopbagispayuser[i].status === "1")
      stringStatus = "Chờ xác nhận";
    else if (ordersOfUser.shopbagispayuser[i].status === "2")
      stringStatus = "Đang gói hàng";
    else if (ordersOfUser.shopbagispayuser[i].status === "3")
      stringStatus = "Vận chuyển";
    else if (ordersOfUser.shopbagispayuser[i].status === "4")
      stringStatus = "Hoàn thành";
    else if (ordersOfUser.shopbagispayuser[i].status === "5")
      stringStatus = "Đã hủy";
    s += `
            <div oncontextmenu="showDetailInformation(event, this)" class="list">
                <span style="width: 10%" class="userID">${ordersOfUser.IDuser}</span>
                <div style="width: 5%; display: flex; justify-content: left;">
                  <input type="checkbox" class="myCheckbox"/>
                </div>
                <span style="width: 10%" class="idProduct">${ordersOfUser.shopbagispayuser[i].obj.idproduct}</span>
                <img style="width: 20%" src="${ordersOfUser.shopbagispayuser[i].obj.img}" class="imgProduct" alt="Ảnh lỗi">
                <span style="width: 30%" class="nameProduct">${ordersOfUser.shopbagispayuser[i].obj.nameSP}</span>
                <span style="width: 5%" class="countProduct">${ordersOfUser.shopbagispayuser[i].soluong}</span>
                <span style="width: 10%" class="priceProduct">${Price}</span>
                <span style="width: 10%" class="deliveryStatus">${stringStatus}</span>
            </div>
    `;
  }
  return s;
}

// set trạng thái vận chuyển cho những đơn hàng đang chọn
function setDH() {
  let getDeliveryStatusSelection = document.getElementById(
    "deliveryStatusSelection"
  ).value;
  // mảng chứa các vị trí của những đơn hàng đang chọn
  let checkboxPositionArray = [];
  let getAllCheckbox = document.querySelectorAll(".myCheckbox");
  for (let i = 0; i < getAllCheckbox.length; i++) {
    if (getAllCheckbox[i].checked) {
      checkboxPositionArray.push(i);
    }
  }
  let filteredProducts = [];
  let count = 0;
  let countOrder = 0;
  // đếm số lượng đơn hàng
  for (let i = 0; i < getShopBag.length; i++) {
    for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
      countOrder++;
    }
  }
  if (getAllCheckbox.length === countOrder) {
    for (let i = 0; i < getShopBag.length; i++) {
      for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
        if (checkboxPositionArray.includes(count)) {
          let obj = {
            IDuser: getShopBag[i].IDuser,
            shopbagispayuser: [getShopBag[i].shopbagispayuser[j]],
          };
          filteredProducts.push(obj);
        }
        count++;
      }
    }
  } else {
    checkboxPositionArray = [];
    getAllCheckbox = document.querySelectorAll(".myCheckbox");
    for (let i = 0; i < getAllCheckbox.length; i++) {
      if (getAllCheckbox[i].checked) {
        checkboxPositionArray.push(i + 1);
      }
    }
    let getProductID = document.querySelectorAll(".idProduct");
    let getUserID = document.querySelectorAll(".userID");
    let storageTmp = [];
    let obj = {};
    for (let i = 1; i < getProductID.length; i++) {
      if (checkboxPositionArray.includes(i)) {
        let obj = {
          IDuser: getUserID[i].innerText,
          idproduct: getProductID[i].innerText,
        };
        storageTmp.push(obj);
      }
    }
    let indexOfStorageTmp = 0;
    for (let i = 0; i < getShopBag.length; i++) {
      if (indexOfStorageTmp === storageTmp.length) break;
      if (
        parseInt(storageTmp[indexOfStorageTmp].IDuser) === getShopBag[i].IDuser
      ) {
        for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
          if (
            storageTmp[indexOfStorageTmp].idproduct ===
            getShopBag[i].shopbagispayuser[j].obj.idproduct
          ) {
            obj = {
              IDuser: getShopBag[i].IDuser,
              shopbagispayuser: [getShopBag[i].shopbagispayuser[j]],
            };
            filteredProducts.push(obj);
            indexOfStorageTmp++;
            if (indexOfStorageTmp === storageTmp.length) break;
          }
        }
      }
    }
  }
  //set trạng thái vận chuyển cho những đơn hàng đang chọn
  for (let i = 0; i < filteredProducts.length; i++) {
    if (getDeliveryStatusSelection === "0") {
      filteredProducts[i].shopbagispayuser[0].status = "1";
    } else if (getDeliveryStatusSelection === "1") {
      filteredProducts[i].shopbagispayuser[0].status = "2";
    } else if (getDeliveryStatusSelection === "2") {
      filteredProducts[i].shopbagispayuser[0].status = "3";
    } else if (getDeliveryStatusSelection === "3") {
      filteredProducts[i].shopbagispayuser[0].status = "4";
    } else if (getDeliveryStatusSelection === "4") {
      filteredProducts[i].shopbagispayuser[0].status = "5";
    }
  }
  // push lên localStorage
  localStorage.setItem("shopbagispay", JSON.stringify(getShopBag));
  // lấy tất cả đơn hàng
  getShopBag = JSON.parse(localStorage.getItem("shopbagispay"));
  let s = "";
  for (let i = 0; i < getShopBag.length; i++) {
    s += listDH(getShopBag[i]);
  }
  document.querySelector("#storage-body").innerHTML = s;
  // reset filteredDeliveryStatus
  let getFilteredDeliveryStatus = document.querySelector(
    "#filteredDeliveryStatus"
  );
  getFilteredDeliveryStatus.innerHTML = `
    <option value="" disabled selected>Lọc trạng thái</option>
    <option value="0">Chờ xác nhận</option>
    <option value="1">Đang gói hàng</option>
    <option value="2">Vận chuyển</option>
    <option value="3">Hoàn thành</option>
    <option value="4">Đã hủy</option>
  `;
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  let getSortByDistrictSeletion = document.getElementById("sortByDistrict");
  getSortByDistrictSeletion.innerHTML = `
    <option value="" disabled selected>Sắp xếp theo quận</option>
    <option value="0">Tăng dần</option>
    <option value="1">Giảm dần</option>
  `;
}

function doYouAccept() {
  setDH();
}

function checkAllButton() {
  let getAllCheckbox = document.querySelectorAll(".myCheckbox");
  for (let i = 0; i < getAllCheckbox.length; i++) {
    getAllCheckbox[i].checked = true;
  }
}

function uncheckAllButton() {
  let getAllCheckbox = document.querySelectorAll(".myCheckbox");
  for (let i = 0; i < getAllCheckbox.length; i++) {
    getAllCheckbox[i].checked = false;
  }
}

function filteredByDeliveryStatus() {
  getShopBag = JSON.parse(localStorage.getItem("shopbagispay"));
  let getFilteredDeliveryStatus = document.querySelector(
    "#filteredDeliveryStatus"
  ).value;
  let number = parseInt(getFilteredDeliveryStatus) + 1;
  let s = "";
  for (let i = 0; i < getShopBag.length; i++) {
    for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
      if (number !== parseInt(getShopBag[i].shopbagispayuser[j].status)) {
        continue;
      }
      let Price = getShopBag[i].shopbagispayuser[j].obj.price.toLocaleString(
        "vi-VN",
        { style: "currency", currency: "VND" }
      );
      let stringStatus = "";
      if (getFilteredDeliveryStatus === "0") stringStatus = "Chờ xác nhận";
      else if (getFilteredDeliveryStatus === "1")
        stringStatus = "Đang gói hàng";
      else if (getFilteredDeliveryStatus === "2") stringStatus = "Vận chuyển";
      else if (getFilteredDeliveryStatus === "3") stringStatus = "Hoàn thành";
      else if (getFilteredDeliveryStatus === "4") stringStatus = "Đã hủy";
      s += `
              <div oncontextmenu="showDetailInformation(event, this)" class="list">
                  <span style="width: 10%" class="userID">${getShopBag[i].IDuser}</span>
                  <div style="width: 5%; display: flex; justify-content: left;">
                    <input type="checkbox" class="myCheckbox"/>
                  </div>
                  <span style="width: 10%" class="idProduct">${getShopBag[i].shopbagispayuser[j].obj.idproduct}</span>
                  <img style="width: 20%" src="${getShopBag[i].shopbagispayuser[j].obj.img}" class="imgProduct" alt="Ảnh lỗi">
                  <span style="width: 30%" class="nameProduct">${getShopBag[i].shopbagispayuser[j].obj.nameSP}</span>
                  <span style="width: 5%" class="countProduct">${getShopBag[i].shopbagispayuser[j].soluong}</span>
                  <span style="width: 10%" class="priceProduct">${Price}</span>
                  <span style="width: 10%" class="deliveryStatus">${stringStatus}</span>
              </div>
      `;
    }
  }
  document.querySelector("#storage-body").innerHTML = s;
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  let getSortByDistrictSeletion = document.getElementById("sortByDistrict");
  getSortByDistrictSeletion.innerHTML = `
    <option value="" disabled selected>Sắp xếp theo quận</option>
    <option value="0">Tăng dần</option>
    <option value="1">Giảm dần</option>
  `;
}
function getDistrict(district) {
  let tmpArray = district.split(", ");
  return tmpArray[2];
}

function sortByDistrict() {
  getShopBag = JSON.parse(localStorage.getItem("shopbagispay")) || [];
  let clonedArray = JSON.parse(JSON.stringify(getShopBag));
  let districtsArray = [];
  let shopbagispay = [];
  for (let i = 0; i < getShopBag.length; i++) {
    for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
      districtsArray.push(
        getDistrict(getShopBag[i].shopbagispayuser[j].diachi)
      );
    }
  }
  let getSortByDistrictSeletion = document.getElementById("sortByDistrict");
  if (getSortByDistrictSeletion.value === "0") {
    districtsArray.sort((a, b) => a.localeCompare(b));
  } else if (getSortByDistrictSeletion.value === "1") {
    districtsArray.sort((a, b) => b.localeCompare(a));
  }
  let flagToBreak = false;
  for (let i = 0; i < clonedArray.length; i++) {
    if (flagToBreak) break;
    for (let j = 0; j < clonedArray[i].shopbagispayuser.length; j++) {
      if (
        getDistrict(clonedArray[i].shopbagispayuser[j].diachi) ===
        districtsArray[0]
      ) {
        let obj = {
          IDuser: clonedArray[i].IDuser,
          shopbagispayuser: [clonedArray[i].shopbagispayuser[j]],
        };
        shopbagispay.push(obj);
        districtsArray.splice(0, 1);
        if (districtsArray.length === 0) {
          flagToBreak = true;
          break;
        }
        let currentOrder = getDistrict(
          clonedArray[i].shopbagispayuser[j].diachi
        );
        clonedArray[i].shopbagispayuser.splice(j, 1);
        // nếu khác quận với đứa bị xóa thì duyệt lại toàn bộ
        if (
          j < clonedArray[i].shopbagispayuser.length &&
          getDistrict(clonedArray[i].shopbagispayuser[j].diachi) !==
            currentOrder
        ) {
          // Đặt i = -1 để sau khi break, ta tăng i thêm 1 => i = 0 => duyệt lại toàn bộ
          i = -1;
          break;
        } else if (j === clonedArray[i].shopbagispayuser.length) {
          i = -1;
          break;
        }
        // nếu chung quận với đứa bị xóa
        j--;
      }
    }
  }
  let s = "";
  for (let i = 0; i < shopbagispay.length; i++) {
    s += listDH(shopbagispay[i]);
  }
  document.querySelector("#storage-body").innerHTML = s;
  // reset filteredDeliveryStatus
  let getFilteredDeliveryStatus = document.querySelector(
    "#filteredDeliveryStatus"
  );
  getFilteredDeliveryStatus.innerHTML = `
    <option value="" disabled selected>Lọc trạng thái</option>
    <option value="0">Chờ xác nhận</option>
    <option value="1">Đang gói hàng</option>
    <option value="2">Vận chuyển</option>
    <option value="3">Hoàn thành</option>
    <option value="4">Đã hủy</option>
  `;
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
}

function filterByDateRange() {
  let getStartDate = document.getElementById("startDate").value;
  let getEndDate = document.getElementById("endDate").value;
  if (getStartDate && getEndDate) {
    let startDate = new Date(getStartDate);
    let endDate = new Date(getEndDate);
    if (endDate < startDate) return;
    getShopBag = JSON.parse(localStorage.getItem("shopbagispay")) || [];
    let filteredByTimeArray = [];
    for (let i = 0; i < getShopBag.length; i++) {
      let ordersArray = [];
      for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
        let deliveryDate = new Date(getShopBag[i].shopbagispayuser[j].time);
        if (deliveryDate >= startDate && deliveryDate <= endDate) {
          ordersArray.push(getShopBag[i].shopbagispayuser[j]);
        }
      }
      if (ordersArray.length > 0) {
        let obj = {
          IDuser: getShopBag[i].IDuser,
          shopbagispayuser: ordersArray,
        };
        filteredByTimeArray.push(obj);
      }
    }
    console.log(filteredByTimeArray);
    let s = "";
    for (let i = 0; i < filteredByTimeArray.length; i++) {
      s += listDH(filteredByTimeArray[i]);
    }
    document.querySelector("#storage-body").innerHTML = s;
    // reset filteredDeliveryStatus
    let getFilteredDeliveryStatus = document.querySelector(
      "#filteredDeliveryStatus"
    );
    getFilteredDeliveryStatus.innerHTML = `
    <option value="" disabled selected>Lọc trạng thái</option>
    <option value="0">Chờ xác nhận</option>
    <option value="1">Đang gói hàng</option>
    <option value="2">Vận chuyển</option>
    <option value="3">Hoàn thành</option>
    <option value="4">Đã hủy</option>
    `;
    let getSortByDistrictSeletion = document.getElementById("sortByDistrict");
    getSortByDistrictSeletion.innerHTML = `
      <option value="" disabled selected>Sắp xếp theo quận</option>
      <option value="0">Tăng dần</option>
      <option value="1">Giảm dần</option>
    `;
  }
}

function renderqldh() {
  document.querySelector(".page-right").innerHTML = `<div class="qldh">
                <div class="title"><h1>QUẢN LÝ ĐƠN HÀNG</h1></div>
                <div class="groupOption">
                        <select name="" class="box" id="filteredDeliveryStatus" onchange="filteredByDeliveryStatus()">
                            <option value="" disabled selected>Lọc theo trạng thái</option>
                            <option value="0">Chờ xác nhận</option>
                            <option value="1">Đang gói hàng</option>
                            <option value="2">Vận chuyển</option>
                            <option value="3">Hoàn thành</option>
                            <option value="4">Đã hủy</option>
                        </select>
                        <select name="" class="box" id="deliveryStatusSelection">
                            <option value="" disabled selected>Chỉnh trạng thái</option>
                            <option value="0">Chờ xác nhận</option>
                            <option value="1">Đang gói hàng</option>
                            <option value="2">Vận chuyển</option>
                            <option value="3">Hoàn thành</option>
                            <option value="4">Đã hủy</option>
                        </select>
                        <select name="" class="box" id="sortByDistrict" onchange="sortByDistrict()">
                            <option value="" disabled selected>Sắp xếp theo quận</option>
                            <option value="0">Tăng dần</option>
                            <option value="1">Giảm dần</option>
                        </select>
                        <button class="box" id="acceptChangeStatus" style="width: 13%;
                          box-shadow: 0 7px 25px rgba(0, 0, 0, 0.2);
                          border-radius: 10px;
                          margin-right: 10px;
                          border: none;
                          height: fit-content;
                          padding: 10px;" onclick="doYouAccept()">Xác nhận chỉnh</button>
                        <div class="box">
                            <div class="contentBox">
                                <div class="leftBox">
                                    <h2 id="amountOfProduct">0</h2>
                                    <span>ĐƠN HÀNG</span>
                                </div>
                                <i class="fa-solid fa-star"></i>
                            </div>
                        </div>
                </div>
                <div class="secondOption" style="margin-top: 30px; padding: 10px; background-color: white;">
                  <p style="margin-bottom: 10px; font-size: 16px; font-weight: bold; color: #333;">Lọc theo khoảng thời gian</p>
                  <input type="date" class="box" id="startDate" onchange="filterByDateRange()">
                  <input type="date" class="box" id="endDate" onchange="filterByDateRange()">
                  <button class="box" id="checkAllButton" style="width: 13%;
                    box-shadow: 0 7px 25px rgba(0, 0, 0, 0.2);
                    border-radius: 10px;
                    margin-right: 10px;
                    border: none;
                    height: fit-content;
                    padding: 10px;" onclick="checkAllButton()">Chọn hết</button>
                  <button class="box" id="uncheckAllButton" style="width: 13%;
                    box-shadow: 0 7px 25px rgba(0, 0, 0, 0.2);
                    border-radius: 10px;
                    margin-right: 100px;
                    border: none;
                    height: fit-content;
                    padding: 10px;" onclick="uncheckAllButton()">Bỏ hết</button>
                </div>
                <div class="titleCol">
                    <span style="width: 10%" class="userID">userID</span>
                    <span style="width: 5%" class="selectProduct">Chọn</span>
                    <span style="width: 10%" class="idProduct">ID</span>
                    <span style="width: 20% ; padding-left: 7%" class="imgProduct">Hình ảnh</span>
                    <span style="width: 30% ; padding-left: 5%" class="nameProduct">Tên sản phẩm</span>
                    <span style="width: 5%" class="countProduct">Số lượng</span>
                    <span style="width: 10%" class="priceProduct">Đơn giá</span>
                    <span style="width: 10%" class="deliveryStatus">Vận chuyển</span>
                </div>
                <div id="storage-body"></div>`;
  let s = "";
  for (let i = 0; i < getShopBag.length; i++) {
    s += listDH(getShopBag[i]);
  }
  document.querySelector("#storage-body").innerHTML = s;
  let countOrder = 0;
  for (let i = 0; i < getShopBag.length; i++) {
    for (let j = 0; j < getShopBag[i].shopbagispayuser.length; j++) {
      countOrder++;
    }
  }
  document.querySelector("#amountOfProduct").innerText = countOrder;
}
// login
let getSignInButton = "";
let getEmailSignIn = "";
let getPasswordSignIn = "";
function checkSignInAdminAccount(email, password) {
  let adminAccount = JSON.parse(localStorage.getItem("adminAccount"));
  if (adminAccount.email === email && adminAccount.password === password) {
    return true;
  }
  return false;
}
function pushFirstAdminAccount() {
  let adminAccount = JSON.parse(localStorage.getItem("adminAccount"));
  let flagAdminAccount = JSON.parse(localStorage.getItem("flagAdminAccount"));
  // nếu adminAccount bị xóa hoặc flag = null (chưa put lần nào) thì push adminAccount
  if (flagAdminAccount === null || adminAccount === null) {
    localStorage.setItem("flagAdminAccount", JSON.stringify(false));
    adminAccount = {
      email: "admin@gmail.com",
      password: "admin",
      typeuser: "0",
    };
    localStorage.setItem("adminAccount", JSON.stringify(adminAccount));
    localStorage.setItem("flagAdminAccount", JSON.stringify(true));
  }
  // nếu flag khác null => true => return vì đã push
  if (flagAdminAccount) {
    return;
  }
}

pushFirstAdminAccount();

const isValidEmail = (email) => {
  const pattern = /^[^ ]+@[^ ]+\.[a-z]{2,3}$/;
  return !!email.match(pattern);
};

function loadpage() {
  window.scrollTo({ top: 0, behavior: "smooth" });
  const loader = document.querySelector(".loader");

  loader.classList.add("active");

  setTimeout(function () {
    loader.classList.remove("active");
  }, 1000);
}
function signInButton(event) {
  event.preventDefault();
  getSignInButton = document.querySelector("#sign-in-button");
  getEmailSignIn = document.querySelector("#Email");
  getPasswordSignIn = document.querySelector("#Password");
  if (!isValidEmail(getEmailSignIn.value)) {
    toast({
      title: "ERROR",
      message: "Vui lòng nhập đúng Email !",
      type: "error",
      duration: 5000,
    });
    getEmailSignIn.focus();
    return;
  } else if (getPasswordSignIn.value.trim() === "") {
    toast({
      title: "ERROR",
      message: "Vui lòng nhập mật khẩu !",
      type: "error",
      duration: 5000,
    });
    getPasswordSignIn.focus();
    return;
  }
  if (checkSignInAdminAccount(getEmailSignIn.value, getPasswordSignIn.value)) {
    loadpage();
    let getPage = document.querySelector(".page");
    getPage.innerHTML = `
      <div class="page-left second-icon">
        <div style="height: 10%" class="F-L"><h1>Tình Hình Hoạt Động</h1></div>
        <div style="height: 60%" class="box-l">
          <div class="L b1">QUẢN LÝ THỐNG KÊ</div>
          <div class="L b2">QUẢN LÝ ĐƠN HÀNG</div>
          <div class="L b3">QUẢN LÝ SẢN PHẨM</div>
          <div class="L b4">QUẢN LÝ NGƯỜI DÙNG</div>
        </div>
        <div class="L-e">
          <a href="./index.html">
            <i class="fa-solid fa-house"></i>TRỞ VỀ TRANG CHỦ</a
          >
        </div>
        <div onclick ="user_click()" class="L-u">
          <div class="_icon_user"><i class="fa-solid fa-user"></i></div>
        </div>
      </div>
      <div class="page-right"></div>

      <div class="btnAddproduct nonez"></div>
      <div class="outbackround"></div>

      <div class="viewmenu nonez"></div>

      <div id="contextMenu" class="context-menu">
        <button id="viewDetails">
          <i style="margin-right: 5px" class="bx bxs-edit" id="button1-contextMenu"></i>Chỉnh sửa
        </button>
        <hr />
        <button id="deleteProduct">
          <i style="margin-right: 5px" class="bx bx-trash" id="button2-contextMenu"></i>Xóa sản phẩm
        </button>
      </div>

      <div class="sb nonesb">
        <h3>XÁC NHẬN</h3>
        <div class="sub">
          <button id="yes">YES</button>
          <button id="no">NO</button>
        </div>
      </div>
        `;
    onload();
    return;
  } else {
    toast({
      title: "ERROR",
      message: "Sai email hoặc mật khẩu !",
      type: "error",
      duration: 5000,
    });
    return;
  }
}
